"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),CanvasSequence=function(){function e(t,n,s,i,a,o,r){var u=arguments.length<=7||void 0===arguments[7]?e.PlayMode.SCROLL:arguments[7],c=arguments.length<=8||void 0===arguments[8]?24:arguments[8],h=!(arguments.length<=9||void 0===arguments[9])&&arguments[9];return _classCallCheck(this,e),"object"==typeof t?this.ctor(t):void this.ctor({canvas:t,sequencePath:n,sequenceStart:s,sequenceEnd:i,fileType:a,loadCallback:o,onDraw:r,mode:u,fps:c,playOnce:h})}return _createClass(e,[{key:"ctor",value:function(t){var n=t.canvas,s=t.sequencePath,i=t.sequenceStart,a=t.sequenceEnd,o=t.fileType,r=t.loadCallback,u=t.onDraw,c=t.mode,h=void 0===c?e.PlayMode.SCROLL:c,l=t.fps,d=void 0===l?24:l,f=t.isPaused,m=void 0!==f&&f,v=t.playOnce,y=void 0!==v&&v;this.sequence=[],this.canvas=document.getElementById(n),null!==this.canvas?this.context=this.canvas.getContext("2d"):console.log("Please ensure the lib is loaded when DOM is loaded."),this.sequencePath=s,this.sequenceStart=i,this.sequenceEnd=a,this.sequenceLength=this.sequenceEnd-this.sequenceStart,this.fileType=o||".png",this.scrollHeight=document.body.scrollHeight,this.loadCallback=r||function(){},this.onDraw="function"==typeof u?u:null,this.mode=h,this.isPaused=m,this.firstLoopEnd=!1,this.fps=d,this.playOnce=y,this.loadSequence()}},{key:"pause",value:function(){this.isPaused=!0}},{key:"play",value:function(){if(this.isPaused){var e=+new Date;this.startTime=e-this.currentFrame/this.fps*1e3,this.isPaused=!1,this.firstLoopEnd=!1}}},{key:"addLeadingZeros",value:function(e){for(var t=this.sequenceEnd.toString().length,n=(e>0?e:-e)+"",s="",i=t-n.length;i>0;i--)s+="0";return s+=n,e>=0?s:"-"+s}},{key:"loadSequence",value:function(){for(var e=this,t=[],n=this.sequenceStart;n<=this.sequenceEnd;n++){var s=this.addLeadingZeros(n),i=this.sequencePath+s+this.fileType,a=new Image;a.src=i;var o=new Promise(function(e,t){a.onload=e,a.onerror=t});t.push(o),this.sequence.push(a)}Promise.all(t).then(function(){e.renderFrame(),e.loadCallback()})["catch"](function(e){console.log(e)})}},{key:"getNextFrameNumber",value:function(){return Math.round(this.progress*this.sequenceLength)}},{key:"syncScrollPosition",value:function(){var e=document.body.scrollTop;return e/this.scrollHeight}},{key:"syncAutoPlayPosition",value:function(){var e=+new Date;if(this.startTime||(this.startTime=e),!this.isPaused){var t=this.sequenceLength/this.fps,n=(e-this.startTime)/1e3%t;return n/t}return this.progress}},{key:"syncPlayPosition",value:function(){switch(this.mode){case e.PlayMode.AUTO:this.progress=this.syncAutoPlayPosition();break;case e.PlayMode.MANUAL:break;case e.PlayMode.SCROLL:default:this.progress=this.syncScrollPosition()}}},{key:"setProgress",value:function(e){this.progress=e}},{key:"drawImage",value:function(e){e>=0&&e<this.sequence.length&&(this.sequence[e].complete?this.context.drawImage(this.sequence[e],0,0,this.canvas.width,this.canvas.height):console.log("The current frame has not been loaded. Please ensure all images are loaded before updating the canvas."))}},{key:"renderFrame",value:function(){var e=this;this.syncPlayPosition(),this.playOnce&&this.firstLoopEnd&&this.pause(),requestAnimationFrame(function(){e.renderFrame()}),this.previousFrame=this.currentFrame,this.currentFrame=this.getNextFrameNumber(),(this.currentFrame!=this.previousFrame||this.firstLoad)&&(this.drawImage(this.currentFrame),this.onDraw&&this.onDraw.call(null,this.previousFrame,this.currentFrame)),this.getNextFrameNumber()===this.sequenceEnd-1&&(this.firstLoopEnd=!0),this.firstLoad=!1}}]),e}();CanvasSequence.PlayMode={SCROLL:"SCROLL",AUTO:"AUTO",MANUAL:"MANUAL"},window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}()),"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return CanvasSequence}):"undefined"!=typeof module&&module.exports?module.exports=CanvasSequence:window.CanvasSequence=CanvasSequence;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhbnZhc1NlcXVlbmNlLmpzIl0sIm5hbWVzIjpbIl9jbGFzc0NhbGxDaGVjayIsImluc3RhbmNlIiwiQ29uc3RydWN0b3IiLCJUeXBlRXJyb3IiLCJfY3JlYXRlQ2xhc3MiLCJkZWZpbmVQcm9wZXJ0aWVzIiwidGFyZ2V0IiwicHJvcHMiLCJpIiwibGVuZ3RoIiwiZGVzY3JpcHRvciIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5Iiwia2V5IiwicHJvdG9Qcm9wcyIsInN0YXRpY1Byb3BzIiwicHJvdG90eXBlIiwiQ2FudmFzU2VxdWVuY2UiLCJjYW52YXNPck9wdHMiLCJzZXF1ZW5jZVBhdGgiLCJzZXF1ZW5jZVN0YXJ0Iiwic2VxdWVuY2VFbmQiLCJmaWxlVHlwZSIsImxvYWRDYWxsYmFjayIsIm9uRHJhdyIsIm1vZGUiLCJhcmd1bWVudHMiLCJ1bmRlZmluZWQiLCJQbGF5TW9kZSIsIlNDUk9MTCIsImZwcyIsInBsYXlPbmNlIiwidGhpcyIsImN0b3IiLCJjYW52YXMiLCJ2YWx1ZSIsIl9yZWYiLCJfcmVmJG1vZGUiLCJfcmVmJGZwcyIsIl9yZWYkaXNQYXVzZWQiLCJpc1BhdXNlZCIsIl9yZWYkcGxheU9uY2UiLCJzZXF1ZW5jZSIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJjb250ZXh0IiwiZ2V0Q29udGV4dCIsImNvbnNvbGUiLCJsb2ciLCJzZXF1ZW5jZUxlbmd0aCIsInNjcm9sbEhlaWdodCIsImJvZHkiLCJmaXJzdExvb3BFbmQiLCJsb2FkU2VxdWVuY2UiLCJub3ciLCJEYXRlIiwic3RhcnRUaW1lIiwiY3VycmVudEZyYW1lIiwibiIsInRvU3RyaW5nIiwic3RyIiwiemVyb3MiLCJfdGhpcyIsInByb21pc2VzIiwiZnJhbWVOdW1iZXIiLCJhZGRMZWFkaW5nWmVyb3MiLCJmaWxlbmFtZSIsImltZyIsIkltYWdlIiwic3JjIiwicHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwib25sb2FkIiwib25lcnJvciIsInB1c2giLCJhbGwiLCJ0aGVuIiwicmVuZGVyRnJhbWUiLCJlIiwiTWF0aCIsInJvdW5kIiwicHJvZ3Jlc3MiLCJzY3JvbGxPZmZzZXQiLCJzY3JvbGxUb3AiLCJzZXF1ZW5jZUR1cmF0aW9uIiwicGxheU9mZnNldCIsIkFVVE8iLCJzeW5jQXV0b1BsYXlQb3NpdGlvbiIsIk1BTlVBTCIsInN5bmNTY3JvbGxQb3NpdGlvbiIsImZyYW1lIiwiY29tcGxldGUiLCJkcmF3SW1hZ2UiLCJ3aWR0aCIsImhlaWdodCIsIl90aGlzMiIsInN5bmNQbGF5UG9zaXRpb24iLCJwYXVzZSIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsInByZXZpb3VzRnJhbWUiLCJnZXROZXh0RnJhbWVOdW1iZXIiLCJmaXJzdExvYWQiLCJjYWxsIiwid2luZG93Iiwid2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwibW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwib1JlcXVlc3RBbmltYXRpb25GcmFtZSIsIm1zUmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwiY2FsbGJhY2siLCJlbGVtZW50Iiwic2V0VGltZW91dCIsImRlZmluZSIsImFtZCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBLFlBSUEsU0FBU0EsaUJBQWdCQyxFQUFVQyxHQUFlLEtBQU1ELFlBQW9CQyxJQUFnQixLQUFNLElBQUlDLFdBQVUscUNBRmhILEdBQUlDLGNBQWUsV0FBZSxRQUFTQyxHQUFpQkMsRUFBUUMsR0FBUyxJQUFLLEdBQUlDLEdBQUksRUFBR0EsRUFBSUQsRUFBTUUsT0FBUUQsSUFBSyxDQUFFLEdBQUlFLEdBQWFILEVBQU1DLEVBQUlFLEdBQVdDLFdBQWFELEVBQVdDLGFBQWMsRUFBT0QsRUFBV0UsY0FBZSxFQUFVLFNBQVdGLEtBQVlBLEVBQVdHLFVBQVcsR0FBTUMsT0FBT0MsZUFBZVQsRUFBUUksRUFBV00sSUFBS04sSUFBaUIsTUFBTyxVQUFVUixFQUFhZSxF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RCxPQUFPRSwwQkFDUEYsT0FBT0csd0JBQ1BILE9BQU9JLHlCQUNQLFNBQThDQyxFQUFtQ0MsR0FDN0VOLE9BQU9PLFdBQVdGLEVBQVUsSUFBTyxTQUs3QixrQkFBWEcsU0FBK0MsZ0JBQWZBLFFBQU9DLEtBQW9CRCxPQUFPQyxJQUN6RUQsT0FBTyxXQUNILE1BQU9oRyxrQkFFYyxtQkFBWGtHLFNBQTBCQSxPQUFPQyxRQUMvQ0QsT0FBT0MsUUFBVW5HLGVBRWpCd0YsT0FBT3hGLGVBQWlCQSIsImZpbGUiOiJjYW52YXNTZXF1ZW5jZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIENhbnZhc1NlcXVlbmNlIHtcblxuICAgIC8qKlxuICAgICAqIEBzZWUgY3RvclxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBjYW52YXNPck9wdHMsXG4gICAgICAgIHNlcXVlbmNlUGF0aCxcbiAgICAgICAgc2VxdWVuY2VTdGFydCxcbiAgICAgICAgc2VxdWVuY2VFbmQsXG4gICAgICAgIGZpbGVUeXBlLFxuICAgICAgICBsb2FkQ2FsbGJhY2ssXG4gICAgICAgIG9uRHJhdyxcbiAgICAgICAgbW9kZSA9IENhbnZhc1NlcXVlbmNlLlBsYXlNb2RlLlNDUk9MTCxcbiAgICAgICAgZnBzID0gMjQsXG4gICAgICAgIHBsYXlPbmNlID0gZmFsc2VcbiAgICApIHtcbiAgICAgICAgaWYgKHR5cGVvZiBjYW52YXNPck9wdHMgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAvLyBmaXJzdCBwYXJhbSBpcyBhbiBvYmplY3Qgb2Ygb3B0aW9uc1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3RvcihjYW52YXNPck9wdHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jdG9yKHtcbiAgICAgICAgICAgIGNhbnZhczogY2FudmFzT3JPcHRzLFxuICAgICAgICAgICAgc2VxdWVuY2VQYXRoLFxuICAgICAgICAgICAgc2VxdWVuY2VTdGFydCxcbiAgICAgICAgICAgIHNlcXVlbmNlRW5kLFxuICAgICAgICAgICAgZmlsZVR5cGUsXG4gICAgICAgICAgICBsb2FkQ2FsbGJhY2ssXG4gICAgICAgICAgICBvbkRyYXcsXG4gICAgICAgICAgICBtb2RlLFxuICAgICAgICAgICAgZnBzLFxuICAgICAgICAgICAgcGxheU9uY2VcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIEBwYXJhbSBvcHRzLmZpbGVUeXBlIHtTdHJpbmd9IC0gdGhlIGZpbGUgZXh0ZW5zaW9uIHlvdSB3YW50IHRvIHVzZSAoZXguXG4gICAgICogJ2pwZycpXG4gICAgICogQHBhcmFtIG9wdHMubG9hZENhbGxiYWNrIHtmdW5jdGlvbn0gLSBhIGNhbGxiYWNrIHRvIGJlIG5vdGlmaWVkIHdoZW4gYWxsXG4gICAgICogaW1hZ2VzIGFyZSBsb2FkZWQgYW5kIHJlYWR5IHRvIHVzZVxuICAgICAqIEBwYXJhbSBvcHRzLm9uRHJhdyB7ZnVuY3Rpb24ocHJldmlvdXNGcmFtZTpJbnQsIGN1cnJlbnRGcmFtZTpJbnQpYH0gLSBhXG4gICAgICogY2FsbGJhY2sgdG8gYmUgbm90aWZpZWQgd2hlbiB0aGUgZHJhd24gZnJhbWUgY2hhbmdlc1xuICAgICAqIEBwYXJhbSBbb3B0cy5tb2RlXSB7U3RyaW5nfSAtIERlZmF1bHRzIHRvIGAnU0NST0xMJ2AuIE1ldGhvZCB0byB1c2UgZm9yXG4gICAgICogY29udHJvbGxpbmcgcGxheWJhY2sgb2YgdGhlIHNlcXVlbmNlXG4gICAgICogU2VlIGBDYW52YXNTZXF1ZW5jZS5QbGF5TW9kZWAgZm9yIGZ1bGwgbGlzdCBvZiBzdXBwb3J0ZWQgcGxheSBtb2Rlc1xuICAgICAqIEBwYXJhbSBvcHRzLmZwcyB7TnVtYmVyfSAtIERlZmF1bHRzIHRvIGAyNGAuIEZyYW1lcyBwZXIgc2Vjb25kIHRvIHVzZSBmb3JcbiAgICAgKiBAcGFyYW0gb3B0cy5pc1BhdXNlZCB7TnVtYmVyfSAtIERlZmF1bHRzIHRvIGBmYWxzZWAuIGB0cnVlYCB0byBpbml0aWFsaXplXG4gICAgICogd2l0aCBwYXVzZWQgYXV0byBwbGF5YmFjayBzdGF0ZS5cbiAgICAgKiBAcGFyYW0gb3B0cy5wbGF5T25jZSB7Qm9vbGVhbn0gLSBEZWZhdWx0cyB0byBgZmFsc2VgLiBhIGZsYWcgdG8gbWFrZSB0aGVcbiAgICAgKiBzZXF1ZW5jZSBwbGF5IG9ubHkgb25jZVxuICAgICAqL1xuICAgIGN0b3Ioe1xuICAgICAgY2FudmFzLFxuICAgICAgc2VxdWVuY2VQYXRoLFxuICAgICAgc2VxdWVuY2VTdGFydCxcbiAgICAgIHNlcXVlbmNlRW5kLFxuICAgICAgZmlsZVR5cGUsXG4gICAgICBsb2FkQ2FsbGJhY2ssXG4gICAgICBvbkRyYXcsXG4gICAgICBtb2RlID0gQ2FudmFzU2VxdWVuY2UuUGxheU1vZGUuU0NST0xMLFxuICAgICAgZnBzID0gMjQsXG4gICAgICBpc1BhdXNlZCA9IGZhbHNlLFxuICAgICAgcGxheU9uY2UgPSBmYWxzZVxuICAgIH0pIHtcbiAgICAgICAgdGhpcy5zZXF1ZW5jZSA9IFtdO1xuXG4gICAgICAgIHRoaXMuY2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY2FudmFzKTtcblxuICAgICAgICBpZih0aGlzLmNhbnZhcyAhPT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gdGhpcy5jYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUGxlYXNlIGVuc3VyZSB0aGUgbGliIGlzIGxvYWRlZCB3aGVuIERPTSBpcyBsb2FkZWQuXCIpXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNlcXVlbmNlUGF0aCA9IHNlcXVlbmNlUGF0aDtcbiAgICAgICAgdGhpcy5zZXF1ZW5jZVN0YXJ0ID0gc2VxdWVuY2VTdGFydDtcbiAgICAgICAgdGhpcy5zZXF1ZW5jZUVuZCA9IHNlcXVlbmNlRW5kO1xuICAgICAgICB0aGlzLnNlcXVlbmNlTGVuZ3RoID0gdGhpcy5zZXF1ZW5jZUVuZCAtIHRoaXMuc2VxdWVuY2VTdGFydDtcblxuICAgICAgICB0aGlzLmZpbGVUeXBlID0gZmlsZVR5cGUgfHwgJy5wbmcnO1xuXG4gICAgICAgIHRoaXMuc2Nyb2xsSGVpZ2h0ID0gZG9jdW1lbnQuYm9keS5zY3JvbGxIZWlnaHQ7XG4gICAgICAgIHRoaXMubG9hZENhbGxiYWNrID0gbG9hZENhbGxiYWNrIHx8IGZ1bmN0aW9uKCkge307XG4gICAgICAgIHRoaXMub25EcmF3ID0gdHlwZW9mIG9uRHJhdyA9PT0gJ2Z1bmN0aW9uJyA/IG9uRHJhdyA6IG51bGw7XG4gICAgICAgIHRoaXMubW9kZSA9IG1vZGU7XG4gICAgICAgIHRoaXMuaXNQYXVzZWQgPSBpc1BhdXNlZDtcbiAgICAgICAgdGhpcy5maXJzdExvb3BFbmQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5mcHMgPSBmcHM7XG4gICAgICAgIHRoaXMucGxheU9uY2UgPSBwbGF5T25jZTtcblxuICAgICAgICB0aGlzLmxvYWRTZXF1ZW5jZSgpO1xuICAgIH1cblxuICAgIHBhdXNlKCkge1xuICAgICAgICB0aGlzLmlzUGF1c2VkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBwbGF5KCkge1xuICAgICAgICBpZiAoIXRoaXMuaXNQYXVzZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHJlc2V0IHN0YXJ0VGltZSBzbyB0aGF0IGl0IGlzIHJlbGF0aXZlIHRvIHRoZSBjdXJyZW50IHJlcGxheSB0aW1lXG4gICAgICAgIGNvbnN0IG5vdyA9ICtuZXcgRGF0ZSgpO1xuICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IG5vdyAtICh0aGlzLmN1cnJlbnRGcmFtZSAvIHRoaXMuZnBzICogMTAwMClcbiAgICAgICAgdGhpcy5pc1BhdXNlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmZpcnN0TG9vcEVuZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIGFkZExlYWRpbmdaZXJvcyhuKSB7XG4gICAgICAgIHZhciBsZW5ndGggPSB0aGlzLnNlcXVlbmNlRW5kLnRvU3RyaW5nKCkubGVuZ3RoO1xuICAgICAgICB2YXIgc3RyID0gKG4gPiAwID8gbiA6IC1uKSArIFwiXCI7XG4gICAgICAgIHZhciB6ZXJvcyA9IFwiXCI7XG4gICAgICAgIGZvciAodmFyIGkgPSBsZW5ndGggLSBzdHIubGVuZ3RoOyBpID4gMDsgaS0tKVxuICAgICAgICAgICAgemVyb3MgKz0gXCIwXCI7XG4gICAgICAgIHplcm9zICs9IHN0cjtcbiAgICAgICAgcmV0dXJuIG4gPj0gMCA/IHplcm9zIDogXCItXCIgKyB6ZXJvcztcbiAgICB9XG5cbiAgICBsb2FkU2VxdWVuY2UoKSB7XG4gICAgICAgIHZhciBwcm9taXNlcyA9IFtdO1xuXG4gICAgICAgIGZvciAodmFyIGkgPSB0aGlzLnNlcXVlbmNlU3RhcnQ7IGkgPD0gdGhpcy5zZXF1ZW5jZUVuZDsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgZnJhbWVOdW1iZXIgPSB0aGlzLmFkZExlYWRpbmdaZXJvcyhpKTtcbiAgICAgICAgICAgIHZhciBmaWxlbmFtZSA9IHRoaXMuc2VxdWVuY2VQYXRoICsgZnJhbWVOdW1iZXIgKyB0aGlzLmZpbGVUeXBlO1xuICAgICAgICAgICAgdmFyIGltZyA9IG5ldyBJbWFnZTtcbiAgICAgICAgICAgIGltZy5zcmMgPSBmaWxlbmFtZTtcblxuICAgICAgICAgICAgdmFyIHByb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgICAgICBpbWcub25sb2FkID0gcmVzb2x2ZTtcbiAgICAgICAgICAgICAgICBpbWcub25lcnJvciA9IHJlamVjdDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBwcm9taXNlcy5wdXNoKHByb21pc2UpO1xuXG4gICAgICAgICAgICB0aGlzLnNlcXVlbmNlLnB1c2goaW1nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyRnJhbWUoKTtcbiAgICAgICAgICAgIHRoaXMubG9hZENhbGxiYWNrKCk7XG4gICAgICAgIH0pLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0TmV4dEZyYW1lTnVtYmVyKCkge1xuICAgICAgICByZXR1cm4gTWF0aC5yb3VuZCh0aGlzLnByb2dyZXNzICogdGhpcy5zZXF1ZW5jZUxlbmd0aCk7XG4gICAgfVxuXG4gICAgc3luY1Njcm9sbFBvc2l0aW9uKCkge1xuICAgICAgICBjb25zdCBzY3JvbGxPZmZzZXQgPSBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcDtcbiAgICAgICAgcmV0dXJuIHNjcm9sbE9mZnNldCAvIHRoaXMuc2Nyb2xsSGVpZ2h0O1xuICAgIH1cblxuICAgIHN5bmNBdXRvUGxheVBvc2l0aW9uKCkge1xuICAgICAgICBjb25zdCBub3cgPSArbmV3IERhdGUoKTtcbiAgICAgICAgaWYgKCF0aGlzLnN0YXJ0VGltZSkge1xuICAgICAgICAgICAgdGhpcy5zdGFydFRpbWUgPSBub3c7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRoaXMuaXNQYXVzZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHNlcXVlbmNlRHVyYXRpb24gPSB0aGlzLnNlcXVlbmNlTGVuZ3RoIC8gdGhpcy5mcHM7XG4gICAgICAgICAgICAvLyBNb2R1bG8gdG8gbG9vcFxuICAgICAgICAgICAgY29uc3QgcGxheU9mZnNldCA9ICgobm93IC0gdGhpcy5zdGFydFRpbWUpIC8gMTAwMCkgJSBzZXF1ZW5jZUR1cmF0aW9uO1xuICAgICAgICAgICAgcmV0dXJuIHBsYXlPZmZzZXQgLyBzZXF1ZW5jZUR1cmF0aW9uO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMucHJvZ3Jlc3M7XG4gICAgfVxuXG4gICAgc3luY1BsYXlQb3NpdGlvbigpIHtcbiAgICAgICAgc3dpdGNoICh0aGlzLm1vZGUpIHtcbiAgICAgICAgICAgIGNhc2UgQ2FudmFzU2VxdWVuY2UuUGxheU1vZGUuQVVUTzoge1xuICAgICAgICAgICAgICAgIHRoaXMucHJvZ3Jlc3MgPSB0aGlzLnN5bmNBdXRvUGxheVBvc2l0aW9uKCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNhc2UgQ2FudmFzU2VxdWVuY2UuUGxheU1vZGUuTUFOVUFMOlxuICAgICAgICAgICAgICAgIC8vIERvIE5vdGhpbmdcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSBDYW52YXNTZXF1ZW5jZS5QbGF5TW9kZS5TQ1JPTEw6XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHRoaXMucHJvZ3Jlc3MgPSB0aGlzLnN5bmNTY3JvbGxQb3NpdGlvbigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2V0UHJvZ3Jlc3MocHJvZ3Jlc3MpIHtcbiAgICAgICAgdGhpcy5wcm9ncmVzcyA9IHByb2dyZXNzO1xuICAgIH1cblxuICAgIGRyYXdJbWFnZShmcmFtZSkge1xuICAgICAgICBpZihmcmFtZSA+PSAwICYmIGZyYW1lIDwgdGhpcy5zZXF1ZW5jZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIGlmKHRoaXMuc2VxdWVuY2VbZnJhbWVdLmNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmRyYXdJbWFnZSh0aGlzLnNlcXVlbmNlW2ZyYW1lXSwgMCwgMCwgdGhpcy5jYW52YXMud2lkdGgsIHRoaXMuY2FudmFzLmhlaWdodCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVGhlIGN1cnJlbnQgZnJhbWUgaGFzIG5vdCBiZWVuIGxvYWRlZC4gUGxlYXNlIGVuc3VyZSBhbGwgaW1hZ2VzIGFyZSBsb2FkZWQgYmVmb3JlIHVwZGF0aW5nIHRoZSBjYW52YXMuXCIpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZW5kZXJGcmFtZSgpIHtcbiAgICAgICAgdGhpcy5zeW5jUGxheVBvc2l0aW9uKCk7XG4gICAgICAgIGlmICggdGhpcy5wbGF5T25jZSAmJiB0aGlzLmZpcnN0TG9vcEVuZCApIHtcbiAgICAgICAgICAgIHRoaXMucGF1c2UoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlckZyYW1lKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMucHJldmlvdXNGcmFtZSA9IHRoaXMuY3VycmVudEZyYW1lO1xuICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuZ2V0TmV4dEZyYW1lTnVtYmVyKCk7XG5cbiAgICAgICAgaWYgKCh0aGlzLmN1cnJlbnRGcmFtZSAhPSB0aGlzLnByZXZpb3VzRnJhbWUpIHx8IHRoaXMuZmlyc3RMb2FkKSB7XG4gICAgICAgICAgICB0aGlzLmRyYXdJbWFnZSh0aGlzLmN1cnJlbnRGcmFtZSk7XG4gICAgICAgICAgICB0aGlzLm9uRHJhdyAmJiB0aGlzLm9uRHJhdy5jYWxsKG51bGwsIHRoaXMucHJldmlvdXNGcmFtZSwgdGhpcy5jdXJyZW50RnJhbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCB0aGlzLmdldE5leHRGcmFtZU51bWJlcigpID09PSB0aGlzLnNlcXVlbmNlRW5kIC0gMSApIHtcbiAgICAgICAgICAgIHRoaXMuZmlyc3RMb29wRW5kID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZmlyc3RMb2FkID0gZmFsc2U7XG4gICAgfVxuXG59XG5cbi8qKlxuICogU3VwcG9ydGVkIHBsYXliYWNrIGNvbnRyb2wgb3B0aW9uc1xuICovXG5DYW52YXNTZXF1ZW5jZS5QbGF5TW9kZSA9IHtcbiAgICAvLyBTQ1JPTEwgLSAoRGVmYXVsdCkgcHJvZ3Jlc3MgaXMgYm91bmQgdG8gc2Nyb2xsIHBvc2l0aW9uIHJlbGF0aXZlIHRvIGhlaWdodFxuICAgIC8vIG9mIGRvY3VtZW50XG4gICAgU0NST0xMOiAnU0NST0xMJyxcblxuICAgIC8vIEFVVE8gLSBub3QgYm91bmQgdG8gc2Nyb2xsLCBwbGF5cyBsaWtlIGEgcmVndWxhciB2aWRlb1xuICAgIEFVVE8gIDogJ0FVVE8nLFxuXG4gICAgLy8gTUFOVUFMIC0gcGxheWJhY2sgbWFuYWdlbWVudCBpcyBsZWZ0IHRvIHRoZSBvd25lci4gRnJhbWUgaXMgdXBkYXRhYmxlIHdpdGhcbiAgICAvLyBgLnNldFByb2dyZXNzYCBtZXRob2QuXG4gICAgTUFOVUFMOiAnTUFOVUFMJ1xufVxuXG5pZiAoIXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUpIHtcbiAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gKGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fFxuICAgICAgICAgICAgd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCAvLyBjb21tZW50IG91dCBpZiBGRjQgaXMgc2xvdyAoaXQgY2FwcyBmcmFtZXJhdGUgYXQgfjMwZnBzOiBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02MzAxMjcpXG4gICAgICAgICAgICB3aW5kb3cub1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fFxuICAgICAgICAgICAgd2luZG93Lm1zUmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8XG4gICAgICAgICAgICBmdW5jdGlvbiggLyogZnVuY3Rpb24gRnJhbWVSZXF1ZXN0Q2FsbGJhY2sgKi8gY2FsbGJhY2ssIC8qIERPTUVsZW1lbnQgRWxlbWVudCAqLyBlbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoY2FsbGJhY2ssIDEwMDAgLyA2MCk7XG4gICAgICAgICAgICB9O1xuICAgIH0pKCk7XG59XG5cbmlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBkZWZpbmUuYW1kID09PSAnb2JqZWN0JyAmJiBkZWZpbmUuYW1kKSB7XG4gICAgZGVmaW5lKGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gQ2FudmFzU2VxdWVuY2U7XG4gICAgfSk7XG59IGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7XG4gICAgbW9kdWxlLmV4cG9ydHMgPSBDYW52YXNTZXF1ZW5jZTtcbn0gZWxzZSB7XG4gICAgd2luZG93LkNhbnZhc1NlcXVlbmNlID0gQ2FudmFzU2VxdWVuY2U7XG59XG4iXX0=
