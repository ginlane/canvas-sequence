"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),CanvasSequence=function(){function e(t,n,s,i,a,o,r){var u=!(arguments.length<=7||void 0===arguments[7])&&arguments[7],c=arguments.length<=8||void 0===arguments[8]?24:arguments[8],l=!(arguments.length<=9||void 0===arguments[9])&&arguments[9];return _classCallCheck(this,e),"object"==typeof t?this.ctor(t):void this.ctor({canvas:t,sequencePath:n,sequenceStart:s,sequenceEnd:i,fileType:a,loadCallback:o,onDraw:r,autoPlay:u,fps:c,playOnce:l})}return _createClass(e,[{key:"ctor",value:function(e){var t=e.canvas,n=e.sequencePath,s=e.sequenceStart,i=e.sequenceEnd,a=e.fileType,o=e.loadCallback,r=e.onDraw,u=e.autoPlay,c=void 0!==u&&u,l=e.fps,h=void 0===l?24:l,d=e.playOnce,f=void 0!==d&&d;this.sequence=[],this.canvas=document.getElementById(t),null!==this.canvas?this.context=this.canvas.getContext("2d"):console.log("Please ensure the lib is loaded when DOM is loaded."),this.sequencePath=n,this.sequenceStart=s,this.sequenceEnd=i,this.sequenceLength=this.sequenceEnd-this.sequenceStart,this.fileType=a||".png",this.scrollHeight=document.body.scrollHeight,this.scrollOffset=document.body.scrollTop,this.clientHeight=window.innerHeight,this.loadCallback=o||function(){},this.onDraw="function"==typeof r?r:null,this.autoPlay=c,this.isPaused=!1,this.firstLoopEnd=!1,this.fps=h,this.playOnce=f,this.loadSequence()}},{key:"pause",value:function(){this.isPaused=!0}},{key:"play",value:function(){if(this.isPaused){var e=+new Date;this.startTime=e-this.currentFrame/this.fps*1e3,this.isPaused=!1,this.firstLoopEnd=!1}}},{key:"addLeadingZeros",value:function(e){for(var t=this.sequenceEnd.toString().length,n=(e>0?e:-e)+"",s="",i=t-n.length;i>0;i--)s+="0";return s+=n,e>=0?s:"-"+s}},{key:"loadSequence",value:function(){for(var e=this,t=[],n=this.sequenceStart;n<=this.sequenceEnd;n++){var s=this.addLeadingZeros(n),i=this.sequencePath+s+this.fileType,a=new Image;a.src=i;var o=new Promise(function(e,t){a.onload=e,a.onerror=t});t.push(o),this.sequence.push(a)}Promise.all(t).then(function(){e.renderFrame(),e.loadCallback()})["catch"](function(e){console.log(e)})}},{key:"getScrollFrameNumber",value:function(){var e=this.scrollOffset/(this.scrollHeight-this.clientHeight)*100,t=Math.round(e*this.sequenceLength/100);return t}},{key:"getAutoPlayFrameNumber",value:function(){return Math.round(this.fps*this.playOffset)}},{key:"getNextFrameNumber",value:function(){return this.autoPlay?this.getAutoPlayFrameNumber():this.getScrollFrameNumber()}},{key:"syncScrollPosition",value:function(){this.scrollOffset=document.body.scrollTop}},{key:"syncAutoPlayPosition",value:function(){var e=+new Date;this.startTime||(this.startTime=e,this.isPaused=!1),this.isPaused||(this.playOffset=(e-this.startTime)/1e3%(this.sequenceLength/this.fps))}},{key:"syncPlayPosition",value:function(){return this.autoPlay?this.syncAutoPlayPosition():this.syncScrollPosition()}},{key:"drawImage",value:function(e){e>=0&&e<this.sequence.length&&(this.sequence[e].complete?this.context.drawImage(this.sequence[e],0,0,this.canvas.width,this.canvas.height):console.log("The current frame has not been loaded. Please ensure all images are loaded before updating the canvas."))}},{key:"renderFrame",value:function(){var e=this;this.syncPlayPosition(),this.playOnce&&this.firstLoopEnd&&this.pause(),requestAnimationFrame(function(){e.renderFrame()}),this.previousFrame=this.currentFrame,this.currentFrame=this.getNextFrameNumber(),(this.currentFrame!=this.previousFrame||this.firstLoad)&&(this.drawImage(this.currentFrame),this.onDraw&&this.onDraw.call(null,this.previousFrame,this.currentFrame)),this.getNextFrameNumber()===this.sequenceEnd-1&&(this.firstLoopEnd=!0),this.firstLoad=!1}}]),e}();window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}()),"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return CanvasSequence}):"undefined"!=typeof module&&module.exports?module.exports=CanvasSequence:window.CanvasSequence=CanvasSequence;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhbnZhc1NlcXVlbmNlLmpzIl0sIm5hbWVzIjpbIl9jbGFzc0NhbGxDaGVjayIsImluc3RhbmNlIiwiQ29uc3RydWN0b3IiLCJUeXBlRXJyb3IiLCJfY3JlYXRlQ2xhc3MiLCJkZWZpbmVQcm9wZXJ0aWVzIiwidGFyZ2V0IiwicHJvcHMiLCJpIiwibGVuZ3RoIiwiZGVzY3JpcHRvciIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5Iiwia2V5IiwicHJvdG9Qcm9wcyIsInN0YXRpY1Byb3BzIiwicHJvdG90eXBlIiwiQ2FudmFzU2VxdWVuY2UiLCJjYW52YXNPck9wdHMiLCJzZXF1ZW5jZVBhdGgiLCJzZXF1ZW5jZVN0YXJ0Iiwic2VxdWVuY2VFbmQiLCJmaWxlVHlwZSIsImxvYWRDYWxsYmFjayIsIm9uRHJhdyIsImF1dG9QbGF5IiwiYXJndW1lbnRzIiwidW5kZWZpbmVkIiwiZnBzIiwicGxheU9uY2UiLCJ0aGlzIiwiY3RvciIsImNhbnZhcyIsInZhbHVlIiwiX3JlZiIsIl9yZWYkYXV0b1BsYXkiLCJfcmVmJGZwcyIsIl9yZWYkcGxheU9uY2UiLCJzZXF1ZW5jZSIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJjb250ZXh0IiwiZ2V0Q29udGV4dCIsImNvbnNvbGUiLCJsb2ciLCJzZXF1ZW5jZUxlbmd0aCIsInNjcm9sbEhlaWdodCIsImJvZHkiLCJzY3JvbGxPZmZzZXQiLCJzY3JvbGxUb3AiLCJjbGllbnRIZWlnaHQiLCJ3aW5kb3ciLCJpbm5lckhlaWdodCIsImlzUGF1c2VkIiwiZmlyc3RMb29wRW5kIiwibG9hZFNlcXVlbmNlIiwibm93IiwiRGF0ZSIsInN0YXJ0VGltZSIsImN1cnJlbnRGcmFtZSIsIm4iLCJ0b1N0cmluZyIsInN0ciIsInplcm9zIiwiX3RoaXMiLCJwcm9taXNlcyIsImZyYW1lTnVtYmVyIiwiYWRkTGVhZGluZ1plcm9zIiwiZmlsZW5hbWUiLCJpbWciLCJJbWFnZSIsInNyYyIsInByb21pc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIm9ubG9hZCIsIm9uZXJyb3IiLCJwdXNoIiwiYWxsIiwidGhlbiIsInJlbmRlckZyYW1lIiwiZSIsInNjcm9sbFBlcmNlbnRhZ2UiLCJjdXJyZW50RnJhbWVOdW1iZXIiLCJNYXRoIiwicm91bmQiLCJwbGF5T2Zmc2V0IiwiZ2V0QXV0b1BsYXlGcmFtZU51bWJlciIsImdldFNjcm9sbEZyYW1lTnVtYmVyIiwic3luY0F1dG9QbGF5UG9zaXRpb24iLCJzeW5jU2Nyb2xsUG9zaXRpb24iLCJmcmFtZSIsImNvbXBsZXRlIiwiZHJhd0ltYWdlIiwid2lkdGgiLCJoZWlnaHQiLCJfdGhpczIiLCJzeW5jUGxheVBvc2l0aW9uIiwicGF1c2UiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJwcmV2aW91c0ZyYW1lIiwiZ2V0TmV4dEZyYW1lTnVtYmVyIiwiZmlyc3RMb2FkIiwiY2FsbCIsIndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSIsIm1velJlcXVlc3RBbmltYXRpb25GcmFtZSIsIm9SZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJtc1JlcXVlc3RBbmltYXRpb25GcmFtZSIsImNhbGxiYWNrIiwiZWxlbWVudCIsInNldFRpbWVvdXQiLCJkZWZpbmUiLCJhbWQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQSxZQUlBLFNBQVNBLGlCQUFnQkMsRUFBVUMsR0FBZSxLQUFNRCxZQUFvQkMsSUFBZ0IsS0FBTSxJQUFJQyxXQUFVLHFDQUZoSCxHQUFJQyxjQUFlLFdBQWUsUUFBU0MsR0FBaUJDLEVBQVFDLEdBQVMsSUFBSyxHQUFJQyxHQUFJLEVBQUdBLEVBQUlELEVBQU1FLE9BQVFELElBQUssQ0FBRSxHQUFJRSxHQUFhSCxFQUFNQyxFQUFJRSxHQUFXQyxXQUFhRCxFQUFXQyxhQUFjLEVBQU9ELEVBQVdFLGNBQWUsRUFBVSxTQUFXRixLQUFZQSxFQUFXRyxVQUFXLEdBQU1DLE9BQU9DLGVBQWVU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d0JBQ1B4RCxPQUFPeUQseUJBQ1AsU0FBOENDLEVBQW1DQyxHQUM3RTNELE9BQU80RCxXQUFXRixFQUFVLElBQU8sU0FLN0Isa0JBQVhHLFNBQStDLGdCQUFmQSxRQUFPQyxLQUFvQkQsT0FBT0MsSUFDekVELE9BQU8sV0FDTCxNQUFPL0Ysa0JBRWdCLG1CQUFYaUcsU0FBMEJBLE9BQU9DLFFBQy9DRCxPQUFPQyxRQUFVbEcsZUFFakJrQyxPQUFPbEMsZUFBaUJBIiwiZmlsZSI6ImNhbnZhc1NlcXVlbmNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY2xhc3MgQ2FudmFzU2VxdWVuY2Uge1xuXG4gICAgLyoqXG4gICAgICogQHNlZSBjdG9yXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY2FudmFzT3JPcHRzLCBzZXF1ZW5jZVBhdGgsIHNlcXVlbmNlU3RhcnQsIHNlcXVlbmNlRW5kLCBmaWxlVHlwZSwgbG9hZENhbGxiYWNrLCBvbkRyYXcsIGF1dG9QbGF5ID0gZmFsc2UsIGZwcyA9IDI0LCBwbGF5T25jZSA9IGZhbHNlKSB7XG4gICAgICAgIGlmICh0eXBlb2YgY2FudmFzT3JPcHRzID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgLy8gZmlyc3QgcGFyYW0gaXMgYW4gb2JqZWN0IG9mIG9wdGlvbnNcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmN0b3IoY2FudmFzT3JPcHRzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY3Rvcih7XG4gICAgICAgICAgICBjYW52YXM6IGNhbnZhc09yT3B0cyxcbiAgICAgICAgICAgIHNlcXVlbmNlUGF0aCxcbiAgICAgICAgICAgIHNlcXVlbmNlU3RhcnQsXG4gICAgICAgICAgICBzZXF1ZW5jZUVuZCxcbiAgICAgICAgICAgIGZpbGVUeXBlLFxuICAgICAgICAgICAgbG9hZENhbGxiYWNrLFxuICAgICAgICAgICAgb25EcmF3LFxuICAgICAgICAgICAgYXV0b1BsYXksXG4gICAgICAgICAgICBmcHMsXG4gICAgICAgICAgICBwbGF5T25jZVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogQHBhcmFtIG9wdHMuY2FudmFzSWQge1N0cmluZ30gLSBpZCBvZiB0aGUgY2FudmFzIHRhZyB5b3Ugd2FudCB0byB1c2VcbiAgICAgKiBAcGFyYW0gb3B0cy5zZXF1ZW5jZVBhdGgge1N0cmluZ30gLSB0aGUgcGF0aCB0byB5b3VyIGltYWdlIHNlcXVlbmNlIChleC4gJy4vaW1nL3NlcXVlbmNlLycpLiBJZiB5b3VyIGltYWdlcyBuYW1lcyBhcmUgcHJlZml4ZWQgKGV4LiBpbWdfMDAwLmpwZykgeW91IG11c3QgaW5jbHVkZSB0aGUgcHJlZml4IGluIHRoZSBwYXRoLlxuICAgICAqIEBwYXJhbSBvcHRzLnNlcXVlbmNlU3RhcnQge0ludH0gLSB0aGUgbnVtYmVyIG9mIHRoZSBmaXJzdCBmcmFtZSAoZXguIGlmIHlvdXIgZmlyc3QgZnJhbWUgaXMgaW1nXzAwMDU2LmpwZyB0aGVuIHNlcXVlbmNlU3RhcnQgPSA1NilcbiAgICAgKiBAcGFyYW0gb3B0cy5zZXF1ZW5jZUVuZCB7SW50fSAtIHRoZSBudW1iZXIgb2YgdGhlIGxhc3QgZnJhbWVcbiAgICAgKiBAcGFyYW0gb3B0cy5maWxlVHlwZSB7U3RyaW5nfSAtIHRoZSBmaWxlIGV4dGVuc2lvbiB5b3Ugd2FudCB0byB1c2UgKGV4LiAnanBnJylcbiAgICAgKiBAcGFyYW0gb3B0cy5sb2FkQ2FsbGJhY2sge2Z1bmN0aW9ufSAtIGEgY2FsbGJhY2sgdG8gYmUgbm90aWZpZWQgd2hlbiBhbGwgaW1hZ2VzIGFyZSBsb2FkZWQgYW5kIHJlYWR5IHRvIHVzZVxuICAgICAqIEBwYXJhbSBvcHRzLm9uRHJhdyB7ZnVuY3Rpb24ocHJldmlvdXNGcmFtZTpJbnQsIGN1cnJlbnRGcmFtZTpJbnQpYH0gLSBhIGNhbGxiYWNrIHRvIGJlIG5vdGlmaWVkIHdoZW4gdGhlIGRyYXduIGZyYW1lIGNoYW5nZXNcbiAgICAgKiBAcGFyYW0gb3B0cy5hdXRvUGxheSB7Qm9vbGVhbn0gLSBEZWZhdWx0cyB0byBgZmFsc2VgLiBhIGZsYWcgdG8gbWFrZSB0aGUgc2VxdWVuY2UgcGxheSB3aXRob3V0IGJpbmRpbmcgdG8gc2Nyb2xsIChsaWtlIGEgcmVndWxhciB2aWRlbylcbiAgICAgKiBAcGFyYW0gb3B0cy5mcHMge051bWJlcn0gLSBEZWZhdWx0cyB0byBgMjRgLiBGcmFtZXMgcGVyIHNlY29uZCB0byB1c2UgZm9yIHZpZGVvLWxpa2UgcGxheWJhY2tcbiAgICAgKiBAcGFyYW0gb3B0cy5wbGF5T25jZSB7Qm9vbGVhbn0gLSBEZWZhdWx0cyB0byBgZmFsc2VgLiBhIGZsYWcgdG8gbWFrZSB0aGUgc2VxdWVuY2UgcGxheSBvbmx5IG9uY2VcbiAgICAgKi9cbiAgICBjdG9yKHsgY2FudmFzLCBzZXF1ZW5jZVBhdGgsIHNlcXVlbmNlU3RhcnQsIHNlcXVlbmNlRW5kLCBmaWxlVHlwZSwgbG9hZENhbGxiYWNrLCBvbkRyYXcsIGF1dG9QbGF5ID0gZmFsc2UsIGZwcyA9IDI0LCBwbGF5T25jZSA9IGZhbHNlIH0pIHtcbiAgICAgICAgdGhpcy5zZXF1ZW5jZSA9IFtdO1xuXG4gICAgICAgIHRoaXMuY2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY2FudmFzKTtcblxuICAgICAgICBpZih0aGlzLmNhbnZhcyAhPT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gdGhpcy5jYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUGxlYXNlIGVuc3VyZSB0aGUgbGliIGlzIGxvYWRlZCB3aGVuIERPTSBpcyBsb2FkZWQuXCIpXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNlcXVlbmNlUGF0aCA9IHNlcXVlbmNlUGF0aDtcbiAgICAgICAgdGhpcy5zZXF1ZW5jZVN0YXJ0ID0gc2VxdWVuY2VTdGFydDtcbiAgICAgICAgdGhpcy5zZXF1ZW5jZUVuZCA9IHNlcXVlbmNlRW5kO1xuICAgICAgICB0aGlzLnNlcXVlbmNlTGVuZ3RoID0gdGhpcy5zZXF1ZW5jZUVuZCAtIHRoaXMuc2VxdWVuY2VTdGFydDtcblxuICAgICAgICB0aGlzLmZpbGVUeXBlID0gZmlsZVR5cGUgfHwgJy5wbmcnO1xuXG4gICAgICAgIHRoaXMuc2Nyb2xsSGVpZ2h0ID0gZG9jdW1lbnQuYm9keS5zY3JvbGxIZWlnaHQ7XG4gICAgICAgIHRoaXMuc2Nyb2xsT2Zmc2V0ID0gZG9jdW1lbnQuYm9keS5zY3JvbGxUb3A7XG4gICAgICAgIHRoaXMuY2xpZW50SGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuXG4gICAgICAgIHRoaXMubG9hZENhbGxiYWNrID0gbG9hZENhbGxiYWNrIHx8IGZ1bmN0aW9uKCkge307XG4gICAgICAgIHRoaXMub25EcmF3ID0gdHlwZW9mIG9uRHJhdyA9PT0gJ2Z1bmN0aW9uJyA/IG9uRHJhdyA6IG51bGw7XG4gICAgICAgIHRoaXMuYXV0b1BsYXkgPSBhdXRvUGxheTtcbiAgICAgICAgdGhpcy5pc1BhdXNlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmZpcnN0TG9vcEVuZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmZwcyA9IGZwcztcbiAgICAgICAgdGhpcy5wbGF5T25jZSA9IHBsYXlPbmNlO1xuXG4gICAgICAgIHRoaXMubG9hZFNlcXVlbmNlKCk7XG4gICAgfVxuXG4gICAgcGF1c2UoKSB7XG4gICAgICAgIHRoaXMuaXNQYXVzZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIHBsYXkoKSB7XG4gICAgICAgIGlmICghdGhpcy5pc1BhdXNlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gcmVzZXQgc3RhcnRUaW1lIHNvIHRoYXQgaXQgaXMgcmVsYXRpdmUgdG8gdGhlIGN1cnJlbnQgcmVwbGF5IHRpbWVcbiAgICAgICAgY29uc3Qgbm93ID0gK25ldyBEYXRlKCk7XG4gICAgICAgIHRoaXMuc3RhcnRUaW1lID0gbm93IC0gKHRoaXMuY3VycmVudEZyYW1lIC8gdGhpcy5mcHMgKiAxMDAwKVxuICAgICAgICB0aGlzLmlzUGF1c2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZmlyc3RMb29wRW5kID0gZmFsc2U7XG4gICAgfVxuXG4gICAgYWRkTGVhZGluZ1plcm9zKG4pIHtcbiAgICAgICAgdmFyIGxlbmd0aCA9IHRoaXMuc2VxdWVuY2VFbmQudG9TdHJpbmcoKS5sZW5ndGg7XG4gICAgICAgIHZhciBzdHIgPSAobiA+IDAgPyBuIDogLW4pICsgXCJcIjtcbiAgICAgICAgdmFyIHplcm9zID0gXCJcIjtcbiAgICAgICAgZm9yICh2YXIgaSA9IGxlbmd0aCAtIHN0ci5sZW5ndGg7IGkgPiAwOyBpLS0pXG4gICAgICAgICAgICB6ZXJvcyArPSBcIjBcIjtcbiAgICAgICAgemVyb3MgKz0gc3RyO1xuICAgICAgICByZXR1cm4gbiA+PSAwID8gemVyb3MgOiBcIi1cIiArIHplcm9zO1xuICAgIH1cblxuICAgIGxvYWRTZXF1ZW5jZSgpIHtcblxuICAgICAgICB2YXIgcHJvbWlzZXMgPSBbXTtcblxuICAgICAgICBmb3IodmFyIGkgPSB0aGlzLnNlcXVlbmNlU3RhcnQ7IGkgPD0gdGhpcy5zZXF1ZW5jZUVuZDsgaSsrKSB7XG5cbiAgICAgICAgICAgIHZhciBmcmFtZU51bWJlciA9IHRoaXMuYWRkTGVhZGluZ1plcm9zKGkpO1xuICAgICAgICAgICAgdmFyIGZpbGVuYW1lID0gdGhpcy5zZXF1ZW5jZVBhdGggKyBmcmFtZU51bWJlciArIHRoaXMuZmlsZVR5cGU7XG4gICAgICAgICAgICB2YXIgaW1nID0gbmV3IEltYWdlO1xuICAgICAgICAgICAgaW1nLnNyYyA9IGZpbGVuYW1lO1xuXG4gICAgICAgICAgICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgIGltZy5vbmxvYWQgPSByZXNvbHZlO1xuICAgICAgICAgICAgICAgIGltZy5vbmVycm9yID0gcmVqZWN0O1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHByb21pc2VzLnB1c2gocHJvbWlzZSk7XG5cbiAgICAgICAgICAgIHRoaXMuc2VxdWVuY2UucHVzaChpbWcpO1xuICAgICAgICB9XG5cbiAgICAgICAgUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJGcmFtZSgpO1xuICAgICAgICAgICAgdGhpcy5sb2FkQ2FsbGJhY2soKTtcbiAgICAgICAgfSkuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBnZXRTY3JvbGxGcmFtZU51bWJlcigpIHtcbiAgICAgICAgdmFyIHNjcm9sbFBlcmNlbnRhZ2UgPSAodGhpcy5zY3JvbGxPZmZzZXQvKHRoaXMuc2Nyb2xsSGVpZ2h0LXRoaXMuY2xpZW50SGVpZ2h0KSkqMTAwO1xuICAgICAgICB2YXIgY3VycmVudEZyYW1lTnVtYmVyID0gTWF0aC5yb3VuZChzY3JvbGxQZXJjZW50YWdlKnRoaXMuc2VxdWVuY2VMZW5ndGgvMTAwKTtcbiAgICAgICAgcmV0dXJuIGN1cnJlbnRGcmFtZU51bWJlcjtcbiAgICB9XG5cbiAgICBnZXRBdXRvUGxheUZyYW1lTnVtYmVyKCkge1xuICAgICAgICByZXR1cm4gTWF0aC5yb3VuZCh0aGlzLmZwcyAqIHRoaXMucGxheU9mZnNldCk7XG4gICAgfVxuXG4gICAgZ2V0TmV4dEZyYW1lTnVtYmVyKCkge1xuICAgICAgICBpZiAodGhpcy5hdXRvUGxheSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QXV0b1BsYXlGcmFtZU51bWJlcigpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsRnJhbWVOdW1iZXIoKTtcbiAgICB9XG5cbiAgICBzeW5jU2Nyb2xsUG9zaXRpb24oKSB7XG4gICAgICAgIHRoaXMuc2Nyb2xsT2Zmc2V0ID0gZG9jdW1lbnQuYm9keS5zY3JvbGxUb3A7XG4gICAgfVxuXG4gICAgc3luY0F1dG9QbGF5UG9zaXRpb24oKSB7XG4gICAgICAgIGNvbnN0IG5vdyA9ICtuZXcgRGF0ZSgpO1xuICAgICAgICBpZiAoIXRoaXMuc3RhcnRUaW1lKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IG5vdztcbiAgICAgICAgICAgIHRoaXMuaXNQYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5pc1BhdXNlZCkge1xuICAgICAgICAgICAgdGhpcy5wbGF5T2Zmc2V0ID0gKChub3cgLSB0aGlzLnN0YXJ0VGltZSkgLyAxMDAwKSAlICh0aGlzLnNlcXVlbmNlTGVuZ3RoIC8gdGhpcy5mcHMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3luY1BsYXlQb3NpdGlvbigpIHtcbiAgICAgICAgLy8gbm8gc2Nyb2xsIHRyYWNraW5nIGZvciBhdXRvcGxheVxuICAgICAgICBpZiAodGhpcy5hdXRvUGxheSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3luY0F1dG9QbGF5UG9zaXRpb24oKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLnN5bmNTY3JvbGxQb3NpdGlvbigpO1xuICAgIH1cblxuICAgIGRyYXdJbWFnZShmcmFtZSkge1xuXG4gICAgICAgIGlmKGZyYW1lID49IDAgJiYgZnJhbWUgPCB0aGlzLnNlcXVlbmNlLmxlbmd0aCkge1xuICAgICAgICAgICAgLy8gdGhpcy5jb250ZXh0LmNsZWFyUmVjdCgwLCAwLCB0aGlzLmNhbnZhcy53aWR0aCwgdGhpcy5jYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgICAgIGlmKHRoaXMuc2VxdWVuY2VbZnJhbWVdLmNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmRyYXdJbWFnZSh0aGlzLnNlcXVlbmNlW2ZyYW1lXSwgMCwgMCwgdGhpcy5jYW52YXMud2lkdGgsIHRoaXMuY2FudmFzLmhlaWdodCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVGhlIGN1cnJlbnQgZnJhbWUgaGFzIG5vdCBiZWVuIGxvYWRlZC4gUGxlYXNlIGVuc3VyZSBhbGwgaW1hZ2VzIGFyZSBsb2FkZWQgYmVmb3JlIHVwZGF0aW5nIHRoZSBjYW52YXMuXCIpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHJlbmRlckZyYW1lKCkge1xuICAgICAgICB0aGlzLnN5bmNQbGF5UG9zaXRpb24oKTtcbiAgICAgICAgaWYgKCB0aGlzLnBsYXlPbmNlICYmIHRoaXMuZmlyc3RMb29wRW5kICkge1xuICAgICAgICAgICAgdGhpcy5wYXVzZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyRnJhbWUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5wcmV2aW91c0ZyYW1lID0gdGhpcy5jdXJyZW50RnJhbWU7XG4gICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5nZXROZXh0RnJhbWVOdW1iZXIoKTtcblxuICAgICAgICBpZiAoKHRoaXMuY3VycmVudEZyYW1lICE9IHRoaXMucHJldmlvdXNGcmFtZSkgfHwgdGhpcy5maXJzdExvYWQpIHtcbiAgICAgICAgICAgIHRoaXMuZHJhd0ltYWdlKHRoaXMuY3VycmVudEZyYW1lKTtcbiAgICAgICAgICAgIHRoaXMub25EcmF3ICYmIHRoaXMub25EcmF3LmNhbGwobnVsbCwgdGhpcy5wcmV2aW91c0ZyYW1lLCB0aGlzLmN1cnJlbnRGcmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIHRoaXMuZ2V0TmV4dEZyYW1lTnVtYmVyKCkgPT09IHRoaXMuc2VxdWVuY2VFbmQgLSAxICkge1xuICAgICAgICAgICAgdGhpcy5maXJzdExvb3BFbmQgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5maXJzdExvYWQgPSBmYWxzZTtcbiAgICB9XG5cbn1cblxuaWYgKCF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSB7XG4gICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IChmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHxcbiAgICAgICAgICAgIHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgLy8gY29tbWVudCBvdXQgaWYgRkY0IGlzIHNsb3cgKGl0IGNhcHMgZnJhbWVyYXRlIGF0IH4zMGZwczogaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjMwMTI3KVxuICAgICAgICAgICAgd2luZG93Lm9SZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHxcbiAgICAgICAgICAgIHdpbmRvdy5tc1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fFxuICAgICAgICAgICAgZnVuY3Rpb24oIC8qIGZ1bmN0aW9uIEZyYW1lUmVxdWVzdENhbGxiYWNrICovIGNhbGxiYWNrLCAvKiBET01FbGVtZW50IEVsZW1lbnQgKi8gZWxlbWVudCkge1xuICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGNhbGxiYWNrLCAxMDAwIC8gNjApO1xuICAgICAgICAgICAgfTtcbiAgICB9KSgpO1xufVxuXG5pZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgZGVmaW5lLmFtZCA9PT0gJ29iamVjdCcgJiYgZGVmaW5lLmFtZCkge1xuICAgIGRlZmluZShmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBDYW52YXNTZXF1ZW5jZTtcbiAgICB9KTtcbn0gZWxzZSBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpIHtcbiAgICBtb2R1bGUuZXhwb3J0cyA9IENhbnZhc1NlcXVlbmNlO1xufSBlbHNlIHtcbiAgICB3aW5kb3cuQ2FudmFzU2VxdWVuY2UgPSBDYW52YXNTZXF1ZW5jZTtcbn1cbiJdfQ==
