"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),CanvasSequence=function(){function e(t,n,s,i,a,o,r){var u=!(arguments.length<=7||void 0===arguments[7])&&arguments[7],c=arguments.length<=8||void 0===arguments[8]?24:arguments[8];arguments.length<=9||void 0===arguments[9]?null:arguments[9],arguments.length<=10||void 0===arguments[10]?null:arguments[10];return _classCallCheck(this,e),"object"==typeof t?this.ctor(t):void this.ctor({canvas:t,sequencePath:n,sequenceStart:s,sequenceEnd:i,fileType:a,loadCallback:o,onDraw:r,autoPlay:u,fps:c})}return _createClass(e,[{key:"ctor",value:function(e){var t=e.canvas,n=e.sequencePath,s=e.sequenceStart,i=e.sequenceEnd,a=e.fileType,o=e.loadCallback,r=e.onDraw,u=e.autoPlay,c=void 0!==u&&u,l=e.fps,h=void 0===l?24:l;this.sequence=[],this.canvas=document.getElementById(t),null!==this.canvas?this.context=this.canvas.getContext("2d"):console.log("Please ensure the lib is loaded when DOM is loaded."),this.sequencePath=n,this.sequenceStart=s,this.sequenceEnd=i,this.sequenceLength=this.sequenceEnd-this.sequenceStart,this.fileType=a||".png",this.scrollHeight=document.body.scrollHeight,this.scrollOffset=document.body.scrollTop,this.clientHeight=window.innerHeight,this.loadCallback=o||function(){},this.onDraw="function"==typeof r?r:null,this.autoPlay=c,this.isPaused=!1,this.fps=h,this.loadSequence()}},{key:"pause",value:function(){this.isPaused=!0}},{key:"play",value:function(){if(this.isPaused){var e=+new Date;this.startTime=e-this.currentFrame/this.fps*1e3,this.isPaused=!1}}},{key:"addLeadingZeros",value:function(e){for(var t=this.sequenceEnd.toString().length,n=(e>0?e:-e)+"",s="",i=t-n.length;i>0;i--)s+="0";return s+=n,e>=0?s:"-"+s}},{key:"loadSequence",value:function(){for(var e=this,t=[],n=this.sequenceStart;n<=this.sequenceEnd;n++){var s=this.addLeadingZeros(n),i=this.sequencePath+s+this.fileType,a=new Image;a.src=i;var o=new Promise(function(e,t){a.onload=e,a.onerror=t});t.push(o),this.sequence.push(a)}Promise.all(t).then(function(){e.renderFrame(),e.loadCallback()})["catch"](function(e){console.log(e)})}},{key:"getScrollFrameNumber",value:function(){var e=this.scrollOffset/(this.scrollHeight-this.clientHeight)*100,t=Math.round(e*this.sequenceLength/100);return t}},{key:"getAutoPlayFrameNumber",value:function(){return Math.round(this.fps*this.playOffset)}},{key:"getNextFrameNumber",value:function(){return this.autoPlay?this.getAutoPlayFrameNumber():this.getScrollFrameNumber()}},{key:"syncScrollPosition",value:function(){this.scrollOffset=document.body.scrollTop}},{key:"syncAutoPlayPosition",value:function(){var e=+new Date;this.startTime||(this.startTime=e,this.isPaused=!1),this.isPaused||(this.playOffset=(e-this.startTime)/1e3%(this.sequenceLength/this.fps))}},{key:"syncPlayPosition",value:function(){return this.autoPlay?this.syncAutoPlayPosition():this.syncScrollPosition()}},{key:"drawImage",value:function(e){e>=0&&e<this.sequence.length&&(this.sequence[e].complete?this.context.drawImage(this.sequence[e],0,0,this.canvas.width,this.canvas.height):console.log("The current frame has not been loaded. Please ensure all images are loaded before updating the canvas."))}},{key:"renderFrame",value:function(){var e=this;this.syncPlayPosition(),requestAnimationFrame(function(){e.renderFrame()}),this.previousFrame=this.currentFrame,this.currentFrame=this.getNextFrameNumber(),(this.currentFrame!=this.previousFrame||this.firstLoad)&&(this.drawImage(this.currentFrame),this.onDraw&&this.onDraw.call(null,this.previousFrame,this.currentFrame)),this.firstLoad=!1}}]),e}();window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}()),"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return CanvasSequence}):"undefined"!=typeof module&&module.exports?module.exports=CanvasSequence:window.CanvasSequence=CanvasSequence;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhbnZhc1NlcXVlbmNlLmpzIl0sIm5hbWVzIjpbIl9jbGFzc0NhbGxDaGVjayIsImluc3RhbmNlIiwiQ29uc3RydWN0b3IiLCJUeXBlRXJyb3IiLCJfY3JlYXRlQ2xhc3MiLCJkZWZpbmVQcm9wZXJ0aWVzIiwidGFyZ2V0IiwicHJvcHMiLCJpIiwibGVuZ3RoIiwiZGVzY3JpcHRvciIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5Iiwia2V5IiwicHJvdG9Qcm9wcyIsInN0YXRpY1Byb3BzIiwicHJvdG90eXBlIiwiQ2FudmFzU2VxdWVuY2UiLCJjYW52YXNPck9wdHMiLCJzZXF1ZW5jZVBhdGgiLCJzZXF1ZW5jZVN0YXJ0Iiwic2VxdWVuY2VFbmQiLCJmaWxlVHlwZSIsImxvYWRDYWxsYmFjayIsIm9uRHJhdyIsImF1dG9QbGF5IiwiYXJndW1lbnRzIiwidW5kZWZpbmVkIiwiZnBzIiwidGhpcyIsImN0b3IiLCJjYW52YXMiLCJ2YWx1ZSIsIl9yZWYiLCJfcmVmJGF1dG9QbGF5IiwiX3JlZiRmcHMiLCJzZXF1ZW5jZSIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJjb250ZXh0IiwiZ2V0Q29udGV4dCIsImNvbnNvbGUiLCJsb2ciLCJzZXF1ZW5jZUxlbmd0aCIsInNjcm9sbEhlaWdodCIsImJvZHkiLCJzY3JvbGxPZmZzZXQiLCJzY3JvbGxUb3AiLCJjbGllbnRIZWlnaHQiLCJ3aW5kb3ciLCJpbm5lckhlaWdodCIsImlzUGF1c2VkIiwibG9hZFNlcXVlbmNlIiwibm93IiwiRGF0ZSIsInN0YXJ0VGltZSIsImN1cnJlbnRGcmFtZSIsIm4iLCJ0b1N0cmluZyIsInN0ciIsInplcm9zIiwiX3RoaXMiLCJwcm9taXNlcyIsImZyYW1lTnVtYmVyIiwiYWRkTGVhZGluZ1plcm9zIiwiZmlsZW5hbWUiLCJpbWciLCJJbWFnZSIsInNyYyIsInByb21pc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIm9ubG9hZCIsIm9uZXJyb3IiLCJwdXNoIiwiYWxsIiwidGhlbiIsInJlbmRlckZyYW1lIiwiZSIsInNjcm9sbFBlcmNlbnRhZ2UiLCJjdXJyZW50RnJhbWVOdW1iZXIiLCJNYXRoIiwicm91bmQiLCJwbGF5T2Zmc2V0IiwiZ2V0QXV0b1BsYXlGcmFtZU51bWJlciIsImdldFNjcm9sbEZyYW1lTnVtYmVyIiwic3luY0F1dG9QbGF5UG9zaXRpb24iLCJzeW5jU2Nyb2xsUG9zaXRpb24iLCJmcmFtZSIsImNvbXBsZXRlIiwiZHJhd0ltYWdlIiwid2lkdGgiLCJoZWlnaHQiLCJfdGhpczIiLCJzeW5jUGxheVBvc2l0aW9uIiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwicHJldmlvdXNGcmFtZSIsImdldE5leHRGcmFtZU51bWJlciIsImZpcnN0TG9hZCIsImNhbGwiLCJ3ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJtb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJvUmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwibXNSZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJjYWxsYmFjayIsImVsZW1lbnQiLCJzZXRUaW1lb3V0IiwiZGVmaW5lIiwiYW1kIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUEsWUFJQSxTQUFTQSxpQkFBZ0JDLEVBQVVDLEdBQWUsS0FBTUQsWUFBb0JDLElBQWdCLEtBQU0sSUFBSUMsV0FBVSxxQ0FGaEgsR0FBSUMsY0FBZSxXQUFlLFFBQVNDLEdBQWlCQyxFQUFRQyxHQUFTLElBQUssR0FBSUMsR0FBSSxFQUFHQSxFQUFJRCxFQUFNRSxPQUFRRCxJQUFLLENBQUUsR0FBSUUsR0FBYUgsRUFBTUMsRUFBSUUsR0FBV0MsV0FBYUQsRUFBV0MsYUFBYyxFQUFPRCxFQUFXRSxjQUFlLEVBQVUsU0FBV0YsS0FBWUEsRUFBV0csVUFBVyxHQUFNQyxPQUFPQyxlQUFlVCxFQUFRSSxFQUFXTSxJQUFLTixJQUFpQixNQUFPLFVBQVVSLEVBQWFlLEVBQVlDLEdB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YW52YXNTZXF1ZW5jZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIENhbnZhc1NlcXVlbmNlIHtcblxuICAgIC8qKlxuICAgICAqIEBzZWUgY3RvclxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNhbnZhc09yT3B0cywgc2VxdWVuY2VQYXRoLCBzZXF1ZW5jZVN0YXJ0LCBzZXF1ZW5jZUVuZCwgZmlsZVR5cGUsIGxvYWRDYWxsYmFjaywgb25EcmF3LCBhdXRvUGxheSA9IGZhbHNlLCBmcHMgPSAyNCwgd2lkdGggPSBudWxsLCBoZWlnaHQgPSBudWxsKSB7XG4gICAgICAgIGlmICh0eXBlb2YgY2FudmFzT3JPcHRzID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgLy8gZmlyc3QgcGFyYW0gaXMgYW4gb2JqZWN0IG9mIG9wdGlvbnNcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmN0b3IoY2FudmFzT3JPcHRzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY3Rvcih7XG4gICAgICAgICAgICBjYW52YXM6IGNhbnZhc09yT3B0cyxcbiAgICAgICAgICAgIHNlcXVlbmNlUGF0aCxcbiAgICAgICAgICAgIHNlcXVlbmNlU3RhcnQsXG4gICAgICAgICAgICBzZXF1ZW5jZUVuZCxcbiAgICAgICAgICAgIGZpbGVUeXBlLFxuICAgICAgICAgICAgbG9hZENhbGxiYWNrLFxuICAgICAgICAgICAgb25EcmF3LFxuICAgICAgICAgICAgYXV0b1BsYXksXG4gICAgICAgICAgICBmcHNcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIEBwYXJhbSBvcHRzLmNhbnZhc0lkIHtTdHJpbmd9IC0gaWQgb2YgdGhlIGNhbnZhcyB0YWcgeW91IHdhbnQgdG8gdXNlXG4gICAgICogQHBhcmFtIG9wdHMuc2VxdWVuY2VQYXRoIHtTdHJpbmd9IC0gdGhlIHBhdGggdG8geW91ciBpbWFnZSBzZXF1ZW5jZSAoZXguICcuL2ltZy9zZXF1ZW5jZS8nKS4gSWYgeW91ciBpbWFnZXMgbmFtZXMgYXJlIHByZWZpeGVkIChleC4gaW1nXzAwMC5qcGcpIHlvdSBtdXN0IGluY2x1ZGUgdGhlIHByZWZpeCBpbiB0aGUgcGF0aC5cbiAgICAgKiBAcGFyYW0gb3B0cy5zZXF1ZW5jZVN0YXJ0IHtJbnR9IC0gdGhlIG51bWJlciBvZiB0aGUgZmlyc3QgZnJhbWUgKGV4LiBpZiB5b3VyIGZpcnN0IGZyYW1lIGlzIGltZ18wMDA1Ni5qcGcgdGhlbiBzZXF1ZW5jZVN0YXJ0ID0gNTYpXG4gICAgICogQHBhcmFtIG9wdHMuc2VxdWVuY2VFbmQge0ludH0gLSB0aGUgbnVtYmVyIG9mIHRoZSBsYXN0IGZyYW1lXG4gICAgICogQHBhcmFtIG9wdHMuZmlsZVR5cGUge1N0cmluZ30gLSB0aGUgZmlsZSBleHRlbnNpb24geW91IHdhbnQgdG8gdXNlIChleC4gJ2pwZycpXG4gICAgICogQHBhcmFtIG9wdHMubG9hZENhbGxiYWNrIHtmdW5jdGlvbn0gLSBhIGNhbGxiYWNrIHRvIGJlIG5vdGlmaWVkIHdoZW4gYWxsIGltYWdlcyBhcmUgbG9hZGVkIGFuZCByZWFkeSB0byB1c2VcbiAgICAgKiBAcGFyYW0gb3B0cy5vbkRyYXcge2Z1bmN0aW9uKHByZXZpb3VzRnJhbWU6SW50LCBjdXJyZW50RnJhbWU6SW50KWB9IC0gYSBjYWxsYmFjayB0byBiZSBub3RpZmllZCB3aGVuIHRoZSBkcmF3biBmcmFtZSBjaGFuZ2VzXG4gICAgICogQHBhcmFtIG9wdHMuYXV0b1BsYXkge0Jvb2xlYW59IC0gRGVmYXVsdHMgdG8gYGZhbHNlYC4gYSBmbGFnIHRvIG1ha2UgdGhlIHNlcXVlbmNlIHBsYXkgd2l0aG91dCBiaW5kaW5nIHRvIHNjcm9sbCAobGlrZSBhIHJlZ3VsYXIgdmlkZW8pXG4gICAgICogQHBhcmFtIG9wdHMuZnBzIHtOdW1iZXJ9IC0gRGVmYXVsdHMgdG8gYDI0YC4gRnJhbWVzIHBlciBzZWNvbmQgdG8gdXNlIGZvciB2aWRlby1saWtlIHBsYXliYWNrXG4gICAgICovXG4gICAgY3Rvcih7IGNhbnZhcywgc2VxdWVuY2VQYXRoLCBzZXF1ZW5jZVN0YXJ0LCBzZXF1ZW5jZUVuZCwgZmlsZVR5cGUsIGxvYWRDYWxsYmFjaywgb25EcmF3LCBhdXRvUGxheSA9IGZhbHNlLCBmcHMgPSAyNCB9KSB7XG4gICAgICAgIHRoaXMuc2VxdWVuY2UgPSBbXTtcblxuICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNhbnZhcyk7XG5cbiAgICAgICAgaWYodGhpcy5jYW52YXMgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlBsZWFzZSBlbnN1cmUgdGhlIGxpYiBpcyBsb2FkZWQgd2hlbiBET00gaXMgbG9hZGVkLlwiKVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXF1ZW5jZVBhdGggPSBzZXF1ZW5jZVBhdGg7XG4gICAgICAgIHRoaXMuc2VxdWVuY2VTdGFydCA9IHNlcXVlbmNlU3RhcnQ7XG4gICAgICAgIHRoaXMuc2VxdWVuY2VFbmQgPSBzZXF1ZW5jZUVuZDtcbiAgICAgICAgdGhpcy5zZXF1ZW5jZUxlbmd0aCA9IHRoaXMuc2VxdWVuY2VFbmQgLSB0aGlzLnNlcXVlbmNlU3RhcnQ7XG5cbiAgICAgICAgdGhpcy5maWxlVHlwZSA9IGZpbGVUeXBlIHx8ICcucG5nJztcblxuICAgICAgICB0aGlzLnNjcm9sbEhlaWdodCA9IGRvY3VtZW50LmJvZHkuc2Nyb2xsSGVpZ2h0O1xuICAgICAgICB0aGlzLnNjcm9sbE9mZnNldCA9IGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wO1xuICAgICAgICB0aGlzLmNsaWVudEhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDtcblxuICAgICAgICB0aGlzLmxvYWRDYWxsYmFjayA9IGxvYWRDYWxsYmFjayB8fCBmdW5jdGlvbigpIHt9O1xuICAgICAgICB0aGlzLm9uRHJhdyA9IHR5cGVvZiBvbkRyYXcgPT09ICdmdW5jdGlvbicgPyBvbkRyYXcgOiBudWxsO1xuICAgICAgICB0aGlzLmF1dG9QbGF5ID0gYXV0b1BsYXk7XG4gICAgICAgIHRoaXMuaXNQYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5mcHMgPSBmcHM7XG5cbiAgICAgICAgdGhpcy5sb2FkU2VxdWVuY2UoKTtcbiAgICB9XG5cbiAgICBwYXVzZSgpIHtcbiAgICAgICAgdGhpcy5pc1BhdXNlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgcGxheSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzUGF1c2VkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyByZXNldCBzdGFydFRpbWUgc28gdGhhdCBpdCBpcyByZWxhdGl2ZSB0byB0aGUgY3VycmVudCByZXBsYXkgdGltZVxuICAgICAgICBjb25zdCBub3cgPSArbmV3IERhdGUoKTtcbiAgICAgICAgdGhpcy5zdGFydFRpbWUgPSBub3cgLSAodGhpcy5jdXJyZW50RnJhbWUgLyB0aGlzLmZwcyAqIDEwMDApXG4gICAgICAgIHRoaXMuaXNQYXVzZWQgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBhZGRMZWFkaW5nWmVyb3Mobikge1xuICAgICAgICB2YXIgbGVuZ3RoID0gdGhpcy5zZXF1ZW5jZUVuZC50b1N0cmluZygpLmxlbmd0aDtcbiAgICAgICAgdmFyIHN0ciA9IChuID4gMCA/IG4gOiAtbikgKyBcIlwiO1xuICAgICAgICB2YXIgemVyb3MgPSBcIlwiO1xuICAgICAgICBmb3IgKHZhciBpID0gbGVuZ3RoIC0gc3RyLmxlbmd0aDsgaSA+IDA7IGktLSlcbiAgICAgICAgICAgIHplcm9zICs9IFwiMFwiO1xuICAgICAgICB6ZXJvcyArPSBzdHI7XG4gICAgICAgIHJldHVybiBuID49IDAgPyB6ZXJvcyA6IFwiLVwiICsgemVyb3M7XG4gICAgfVxuXG4gICAgbG9hZFNlcXVlbmNlKCkge1xuXG4gICAgICAgIHZhciBwcm9taXNlcyA9IFtdO1xuXG4gICAgICAgIGZvcih2YXIgaSA9IHRoaXMuc2VxdWVuY2VTdGFydDsgaSA8PSB0aGlzLnNlcXVlbmNlRW5kOyBpKyspIHtcblxuICAgICAgICAgICAgdmFyIGZyYW1lTnVtYmVyID0gdGhpcy5hZGRMZWFkaW5nWmVyb3MoaSk7XG4gICAgICAgICAgICB2YXIgZmlsZW5hbWUgPSB0aGlzLnNlcXVlbmNlUGF0aCArIGZyYW1lTnVtYmVyICsgdGhpcy5maWxlVHlwZTtcbiAgICAgICAgICAgIHZhciBpbWcgPSBuZXcgSW1hZ2U7XG4gICAgICAgICAgICBpbWcuc3JjID0gZmlsZW5hbWU7XG5cbiAgICAgICAgICAgIHZhciBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICAgICAgaW1nLm9ubG9hZCA9IHJlc29sdmU7XG4gICAgICAgICAgICAgICAgaW1nLm9uZXJyb3IgPSByZWplY3Q7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcHJvbWlzZXMucHVzaChwcm9taXNlKTtcblxuICAgICAgICAgICAgdGhpcy5zZXF1ZW5jZS5wdXNoKGltZyk7XG4gICAgICAgIH1cblxuICAgICAgICBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlckZyYW1lKCk7XG4gICAgICAgICAgICB0aGlzLmxvYWRDYWxsYmFjaygpO1xuICAgICAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldFNjcm9sbEZyYW1lTnVtYmVyKCkge1xuICAgICAgICB2YXIgc2Nyb2xsUGVyY2VudGFnZSA9ICh0aGlzLnNjcm9sbE9mZnNldC8odGhpcy5zY3JvbGxIZWlnaHQtdGhpcy5jbGllbnRIZWlnaHQpKSoxMDA7XG4gICAgICAgIHZhciBjdXJyZW50RnJhbWVOdW1iZXIgPSBNYXRoLnJvdW5kKHNjcm9sbFBlcmNlbnRhZ2UqdGhpcy5zZXF1ZW5jZUxlbmd0aC8xMDApO1xuICAgICAgICByZXR1cm4gY3VycmVudEZyYW1lTnVtYmVyO1xuICAgIH1cblxuICAgIGdldEF1dG9QbGF5RnJhbWVOdW1iZXIoKSB7XG4gICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHRoaXMuZnBzICogdGhpcy5wbGF5T2Zmc2V0KTtcbiAgICB9XG5cbiAgICBnZXROZXh0RnJhbWVOdW1iZXIoKSB7XG4gICAgICAgIGlmICh0aGlzLmF1dG9QbGF5KSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRBdXRvUGxheUZyYW1lTnVtYmVyKCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5nZXRTY3JvbGxGcmFtZU51bWJlcigpO1xuICAgIH1cblxuICAgIHN5bmNTY3JvbGxQb3NpdGlvbigpIHtcbiAgICAgICAgdGhpcy5zY3JvbGxPZmZzZXQgPSBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcDtcbiAgICB9XG5cbiAgICBzeW5jQXV0b1BsYXlQb3NpdGlvbigpIHtcbiAgICAgICAgY29uc3Qgbm93ID0gK25ldyBEYXRlKCk7XG4gICAgICAgIGlmICghdGhpcy5zdGFydFRpbWUpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lID0gbm93O1xuICAgICAgICAgICAgdGhpcy5pc1BhdXNlZCA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLmlzUGF1c2VkKSB7XG4gICAgICAgICAgICB0aGlzLnBsYXlPZmZzZXQgPSAoKG5vdyAtIHRoaXMuc3RhcnRUaW1lKSAvIDEwMDApICUgKHRoaXMuc2VxdWVuY2VMZW5ndGggLyB0aGlzLmZwcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzeW5jUGxheVBvc2l0aW9uKCkge1xuICAgICAgICAvLyBubyBzY3JvbGwgdHJhY2tpbmcgZm9yIGF1dG9wbGF5XG4gICAgICAgIGlmICh0aGlzLmF1dG9QbGF5KSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zeW5jQXV0b1BsYXlQb3NpdGlvbigpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuc3luY1Njcm9sbFBvc2l0aW9uKCk7XG4gICAgfVxuXG4gICAgZHJhd0ltYWdlKGZyYW1lKSB7XG5cbiAgICAgICAgaWYoZnJhbWUgPj0gMCAmJiBmcmFtZSA8IHRoaXMuc2VxdWVuY2UubGVuZ3RoKSB7XG4gICAgICAgICAgICAvLyB0aGlzLmNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHRoaXMuY2FudmFzLndpZHRoLCB0aGlzLmNhbnZhcy5oZWlnaHQpO1xuICAgICAgICAgICAgaWYodGhpcy5zZXF1ZW5jZVtmcmFtZV0uY29tcGxldGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZHJhd0ltYWdlKHRoaXMuc2VxdWVuY2VbZnJhbWVdLCAwLCAwLCB0aGlzLmNhbnZhcy53aWR0aCwgdGhpcy5jYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJUaGUgY3VycmVudCBmcmFtZSBoYXMgbm90IGJlZW4gbG9hZGVkLiBQbGVhc2UgZW5zdXJlIGFsbCBpbWFnZXMgYXJlIGxvYWRlZCBiZWZvcmUgdXBkYXRpbmcgdGhlIGNhbnZhcy5cIilcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcmVuZGVyRnJhbWUoKSB7XG5cbiAgICAgICAgdGhpcy5zeW5jUGxheVBvc2l0aW9uKCk7XG5cbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyRnJhbWUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5wcmV2aW91c0ZyYW1lID0gdGhpcy5jdXJyZW50RnJhbWU7XG4gICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5nZXROZXh0RnJhbWVOdW1iZXIoKTtcblxuICAgICAgICBpZiAoKHRoaXMuY3VycmVudEZyYW1lICE9IHRoaXMucHJldmlvdXNGcmFtZSkgfHwgdGhpcy5maXJzdExvYWQpIHtcbiAgICAgICAgICAgIHRoaXMuZHJhd0ltYWdlKHRoaXMuY3VycmVudEZyYW1lKTtcbiAgICAgICAgICAgIHRoaXMub25EcmF3ICYmIHRoaXMub25EcmF3LmNhbGwobnVsbCwgdGhpcy5wcmV2aW91c0ZyYW1lLCB0aGlzLmN1cnJlbnRGcmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmZpcnN0TG9hZCA9IGZhbHNlO1xuICAgIH1cblxufVxuXG5pZiAoIXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUpIHtcbiAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gKGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fFxuICAgICAgICAgICAgd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCAvLyBjb21tZW50IG91dCBpZiBGRjQgaXMgc2xvdyAoaXQgY2FwcyBmcmFtZXJhdGUgYXQgfjMwZnBzOiBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02MzAxMjcpXG4gICAgICAgICAgICB3aW5kb3cub1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fFxuICAgICAgICAgICAgd2luZG93Lm1zUmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8XG4gICAgICAgICAgICBmdW5jdGlvbiggLyogZnVuY3Rpb24gRnJhbWVSZXF1ZXN0Q2FsbGJhY2sgKi8gY2FsbGJhY2ssIC8qIERPTUVsZW1lbnQgRWxlbWVudCAqLyBlbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoY2FsbGJhY2ssIDEwMDAgLyA2MCk7XG4gICAgICAgICAgICB9O1xuICAgIH0pKCk7XG59XG5cbmlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBkZWZpbmUuYW1kID09PSAnb2JqZWN0JyAmJiBkZWZpbmUuYW1kKSB7XG4gICAgZGVmaW5lKGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIENhbnZhc1NlcXVlbmNlO1xuICAgIH0pO1xufSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykge1xuICAgIG1vZHVsZS5leHBvcnRzID0gQ2FudmFzU2VxdWVuY2U7XG59IGVsc2Uge1xuICAgIHdpbmRvdy5DYW52YXNTZXF1ZW5jZSA9IENhbnZhc1NlcXVlbmNlO1xufVxuIl19
