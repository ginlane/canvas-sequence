"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),CanvasSequence=function(){function e(t,n,s,i,a,o,r){var u=!(arguments.length<=7||void 0===arguments[7])&&arguments[7],c=arguments.length<=8||void 0===arguments[8]?24:arguments[8];return _classCallCheck(this,e),"object"==typeof t?this.ctor(t):void this.ctor({canvas:t,sequencePath:n,sequenceStart:s,sequenceEnd:i,fileType:a,loadCallback:o,onDraw:r,autoPlay:u,fps:c})}return _createClass(e,[{key:"ctor",value:function(e){var t=e.canvas,n=e.sequencePath,s=e.sequenceStart,i=e.sequenceEnd,a=e.fileType,o=e.loadCallback,r=e.onDraw,u=e.autoPlay,c=void 0!==u&&u,h=e.fps,l=void 0===h?24:h;this.sequence=[],this.canvas=document.getElementById(t),null!==this.canvas?this.context=this.canvas.getContext("2d"):console.log("Please ensure the lib is loaded when DOM is loaded."),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.sequencePath=n,this.sequenceStart=s,this.sequenceEnd=i,this.sequenceLength=this.sequenceEnd-this.sequenceStart,this.fileType=a||".png",this.scrollHeight=document.body.scrollHeight,this.scrollOffset=document.body.scrollTop,this.clientHeight=window.innerHeight,this.loadCallback=o||function(){},this.onDraw="function"==typeof r?r:null,this.autoPlay=c,this.isPaused=!1,this.fps=l,this.loadSequence()}},{key:"pause",value:function(){this.isPaused=!0}},{key:"play",value:function(){if(this.isPaused){var e=+new Date;this.startTime=e-this.currentFrame/this.fps*1e3,this.isPaused=!1}}},{key:"addLeadingZeros",value:function(e){for(var t=this.sequenceEnd.toString().length,n=(e>0?e:-e)+"",s="",i=t-n.length;i>0;i--)s+="0";return s+=n,e>=0?s:"-"+s}},{key:"loadSequence",value:function(){for(var e=this,t=[],n=this.sequenceStart;n<=this.sequenceEnd;n++){var s=this.addLeadingZeros(n),i=this.sequencePath+s+this.fileType,a=new Image;a.src=i;var o=new Promise(function(e,t){a.onload=e,a.onerror=t});t.push(o),this.sequence.push(a)}Promise.all(t).then(function(){e.renderFrame(),e.loadCallback()})["catch"](function(e){console.log(e)})}},{key:"getScrollFrameNumber",value:function(){var e=this.scrollOffset/(this.scrollHeight-this.clientHeight)*100,t=Math.round(e*this.sequenceLength/100);return t}},{key:"getAutoPlayFrameNumber",value:function(){return Math.round(this.fps*this.playOffset)}},{key:"getNextFrameNumber",value:function(){return this.autoPlay?this.getAutoPlayFrameNumber():this.getScrollFrameNumber()}},{key:"syncScrollPosition",value:function(){this.scrollOffset=document.body.scrollTop}},{key:"syncAutoPlayPosition",value:function(){var e=+new Date;this.startTime||(this.startTime=e,this.isPaused=!1),this.isPaused||(this.playOffset=(e-this.startTime)/1e3%(this.sequenceLength/this.fps))}},{key:"syncPlayPosition",value:function(){return this.autoPlay?this.syncAutoPlayPosition():this.syncScrollPosition()}},{key:"drawImage",value:function(e){e>=0&&e<this.sequence.length&&(this.sequence[e].complete?this.context.drawImage(this.sequence[e],0,0,this.canvas.width,this.canvas.height):console.log("The current frame has not been loaded. Please ensure all images are loaded before updating the canvas."))}},{key:"renderFrame",value:function(){var e=this;this.syncPlayPosition(),requestAnimationFrame(function(){e.renderFrame()}),this.previousFrame=this.currentFrame,this.currentFrame=this.getNextFrameNumber(),(this.currentFrame!=this.previousFrame||this.firstLoad)&&(this.drawImage(this.currentFrame),this.onDraw&&this.onDraw.call(null,this.previousFrame,this.currentFrame)),this.firstLoad=!1}}]),e}();window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}()),"function"==typeof define&&define.amd?define("CanvasSequence",CanvasSequence):"undefined"!=typeof module&&module.exports?module.exports=CanvasSequence:window.CanvasSequence=CanvasSequence;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhbnZhc1NlcXVlbmNlLmpzIl0sIm5hbWVzIjpbIl9jbGFzc0NhbGxDaGVjayIsImluc3RhbmNlIiwiQ29uc3RydWN0b3IiLCJUeXBlRXJyb3IiLCJfY3JlYXRlQ2xhc3MiLCJkZWZpbmVQcm9wZXJ0aWVzIiwidGFyZ2V0IiwicHJvcHMiLCJpIiwibGVuZ3RoIiwiZGVzY3JpcHRvciIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5Iiwia2V5IiwicHJvdG9Qcm9wcyIsInN0YXRpY1Byb3BzIiwicHJvdG90eXBlIiwiQ2FudmFzU2VxdWVuY2UiLCJjYW52YXNPck9wdHMiLCJzZXF1ZW5jZVBhdGgiLCJzZXF1ZW5jZVN0YXJ0Iiwic2VxdWVuY2VFbmQiLCJmaWxlVHlwZSIsImxvYWRDYWxsYmFjayIsIm9uRHJhdyIsImF1dG9QbGF5IiwiYXJndW1lbnRzIiwidW5kZWZpbmVkIiwiZnBzIiwidGhpcyIsImN0b3IiLCJjYW52YXMiLCJ2YWx1ZSIsIl9yZWYiLCJfcmVmJGF1dG9QbGF5IiwiX3JlZiRmcHMiLCJzZXF1ZW5jZSIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJjb250ZXh0IiwiZ2V0Q29udGV4dCIsImNvbnNvbGUiLCJsb2ciLCJ3aWR0aCIsIndpbmRvdyIsImlubmVyV2lkdGgiLCJoZWlnaHQiLCJpbm5lckhlaWdodCIsInNlcXVlbmNlTGVuZ3RoIiwic2Nyb2xsSGVpZ2h0IiwiYm9keSIsInNjcm9sbE9mZnNldCIsInNjcm9sbFRvcCIsImNsaWVudEhlaWdodCIsImlzUGF1c2VkIiwibG9hZFNlcXVlbmNlIiwibm93IiwiRGF0ZSIsInN0YXJ0VGltZSIsImN1cnJlbnRGcmFtZSIsIm4iLCJ0b1N0cmluZyIsInN0ciIsInplcm9zIiwiX3RoaXMiLCJwcm9taXNlcyIsImZyYW1lTnVtYmVyIiwiYWRkTGVhZGluZ1plcm9zIiwiZmlsZW5hbWUiLCJpbWciLCJJbWFnZSIsInNyYyIsInByb21pc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIm9ubG9hZCIsIm9uZXJyb3IiLCJwdXNoIiwiYWxsIiwidGhlbiIsInJlbmRlckZyYW1lIiwiZSIsInNjcm9sbFBlcmNlbnRhZ2UiLCJjdXJyZW50RnJhbWVOdW1iZXIiLCJNYXRoIiwicm91bmQiLCJwbGF5T2Zmc2V0IiwiZ2V0QXV0b1BsYXlGcmFtZU51bWJlciIsImdldFNjcm9sbEZyYW1lTnVtYmVyIiwic3luY0F1dG9QbGF5UG9zaXRpb24iLCJzeW5jU2Nyb2xsUG9zaXRpb24iLCJmcmFtZSIsImNvbXBsZXRlIiwiZHJhd0ltYWdlIiwiX3RoaXMyIiwic3luY1BsYXlQb3NpdGlvbiIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsInByZXZpb3VzRnJhbWUiLCJnZXROZXh0RnJhbWVOdW1iZXIiLCJmaXJzdExvYWQiLCJjYWxsIiwid2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwibW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwib1JlcXVlc3RBbmltYXRpb25GcmFtZSIsIm1zUmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwiY2FsbGJhY2siLCJlbGVtZW50Iiwic2V0VGltZW91dCIsImRlZmluZSIsImFtZCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBLFlBSUEsU0FBU0EsaUJBQWdCQyxFQUFVQyxHQUFlLEtBQU1ELFlBQW9CQyxJQUFnQixLQUFNLElBQUlDLFdBQVUscUNBRmhILEdBQUlDLGNBQWUsV0FBZSxRQUFTQyxHQUFpQkMsRUFBUUMsR0FBUyxJQUFLLEdBQUlDLEdBQUksRUFBR0EsRUFBSUQsRUFBTUUsT0FBUUQsSUFBSyxDQUFFLEdBQUlFLEdBQWFILEVBQU1DLEVBQUlFLEdBQVdDLFdBQWFELEVBQVdDLGFBQWMsRUFBT0QsRUFBV0UsY0FBZSxFQUFVLFNBQVdGLEtBQVlBLEVBQVdHLFVBQVcsR0FBTUMsT0FBT0MsZUFBZVQsRUFBUUksRUFBV00sSUFBS04sSUFBaUIsTUFBTyxVQUFVUixF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dmFzU2VxdWVuY2Uge1xuXG4gICAgLyoqXG4gICAgICogQHNlZSBjdG9yXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY2FudmFzT3JPcHRzLCBzZXF1ZW5jZVBhdGgsIHNlcXVlbmNlU3RhcnQsIHNlcXVlbmNlRW5kLCBmaWxlVHlwZSwgbG9hZENhbGxiYWNrLCBvbkRyYXcsIGF1dG9QbGF5ID0gZmFsc2UsIGZwcyA9IDI0KSB7XG4gICAgICAgIGlmICh0eXBlb2YgY2FudmFzT3JPcHRzID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgLy8gZmlyc3QgcGFyYW0gaXMgYW4gb2JqZWN0IG9mIG9wdGlvbnNcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmN0b3IoY2FudmFzT3JPcHRzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY3Rvcih7XG4gICAgICAgICAgICBjYW52YXM6IGNhbnZhc09yT3B0cyxcbiAgICAgICAgICAgIHNlcXVlbmNlUGF0aCxcbiAgICAgICAgICAgIHNlcXVlbmNlU3RhcnQsXG4gICAgICAgICAgICBzZXF1ZW5jZUVuZCxcbiAgICAgICAgICAgIGZpbGVUeXBlLFxuICAgICAgICAgICAgbG9hZENhbGxiYWNrLFxuICAgICAgICAgICAgb25EcmF3LFxuICAgICAgICAgICAgYXV0b1BsYXksXG4gICAgICAgICAgICBmcHNcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIEBwYXJhbSBvcHRzLmNhbnZhc0lkIHtTdHJpbmd9IC0gaWQgb2YgdGhlIGNhbnZhcyB0YWcgeW91IHdhbnQgdG8gdXNlXG4gICAgICogQHBhcmFtIG9wdHMuc2VxdWVuY2VQYXRoIHtTdHJpbmd9IC0gdGhlIHBhdGggdG8geW91ciBpbWFnZSBzZXF1ZW5jZSAoZXguICcuL2ltZy9zZXF1ZW5jZS8nKS4gSWYgeW91ciBpbWFnZXMgbmFtZXMgYXJlIHByZWZpeGVkIChleC4gaW1nXzAwMC5qcGcpIHlvdSBtdXN0IGluY2x1ZGUgdGhlIHByZWZpeCBpbiB0aGUgcGF0aC5cbiAgICAgKiBAcGFyYW0gb3B0cy5zZXF1ZW5jZVN0YXJ0IHtJbnR9IC0gdGhlIG51bWJlciBvZiB0aGUgZmlyc3QgZnJhbWUgKGV4LiBpZiB5b3VyIGZpcnN0IGZyYW1lIGlzIGltZ18wMDA1Ni5qcGcgdGhlbiBzZXF1ZW5jZVN0YXJ0ID0gNTYpXG4gICAgICogQHBhcmFtIG9wdHMuc2VxdWVuY2VFbmQge0ludH0gLSB0aGUgbnVtYmVyIG9mIHRoZSBsYXN0IGZyYW1lXG4gICAgICogQHBhcmFtIG9wdHMuZmlsZVR5cGUge1N0cmluZ30gLSB0aGUgZmlsZSBleHRlbnNpb24geW91IHdhbnQgdG8gdXNlIChleC4gJ2pwZycpXG4gICAgICogQHBhcmFtIG9wdHMubG9hZENhbGxiYWNrIHtmdW5jdGlvbn0gLSBhIGNhbGxiYWNrIHRvIGJlIG5vdGlmaWVkIHdoZW4gYWxsIGltYWdlcyBhcmUgbG9hZGVkIGFuZCByZWFkeSB0byB1c2VcbiAgICAgKiBAcGFyYW0gb3B0cy5vbkRyYXcge2Z1bmN0aW9uKHByZXZpb3VzRnJhbWU6SW50LCBjdXJyZW50RnJhbWU6SW50KWB9IC0gYSBjYWxsYmFjayB0byBiZSBub3RpZmllZCB3aGVuIHRoZSBkcmF3biBmcmFtZSBjaGFuZ2VzXG4gICAgICogQHBhcmFtIG9wdHMuYXV0b1BsYXkge0Jvb2xlYW59IC0gRGVmYXVsdHMgdG8gYGZhbHNlYC4gYSBmbGFnIHRvIG1ha2UgdGhlIHNlcXVlbmNlIHBsYXkgd2l0aG91dCBiaW5kaW5nIHRvIHNjcm9sbCAobGlrZSBhIHJlZ3VsYXIgdmlkZW8pXG4gICAgICogQHBhcmFtIG9wdHMuZnBzIHtOdW1iZXJ9IC0gRGVmYXVsdHMgdG8gYDI0YC4gRnJhbWVzIHBlciBzZWNvbmQgdG8gdXNlIGZvciB2aWRlby1saWtlIHBsYXliYWNrXG4gICAgICovXG4gICAgY3Rvcih7IGNhbnZhcywgc2VxdWVuY2VQYXRoLCBzZXF1ZW5jZVN0YXJ0LCBzZXF1ZW5jZUVuZCwgZmlsZVR5cGUsIGxvYWRDYWxsYmFjaywgb25EcmF3LCBhdXRvUGxheSA9IGZhbHNlLCBmcHMgPSAyNCB9KSB7XG4gICAgICAgIHRoaXMuc2VxdWVuY2UgPSBbXTtcblxuICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNhbnZhcyk7XG5cbiAgICAgICAgaWYodGhpcy5jYW52YXMgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlBsZWFzZSBlbnN1cmUgdGhlIGxpYiBpcyBsb2FkZWQgd2hlbiBET00gaXMgbG9hZGVkLlwiKVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgICAgICAgdGhpcy5jYW52YXMuaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuXG4gICAgICAgIHRoaXMuc2VxdWVuY2VQYXRoID0gc2VxdWVuY2VQYXRoO1xuICAgICAgICB0aGlzLnNlcXVlbmNlU3RhcnQgPSBzZXF1ZW5jZVN0YXJ0O1xuICAgICAgICB0aGlzLnNlcXVlbmNlRW5kID0gc2VxdWVuY2VFbmQ7XG4gICAgICAgIHRoaXMuc2VxdWVuY2VMZW5ndGggPSB0aGlzLnNlcXVlbmNlRW5kIC0gdGhpcy5zZXF1ZW5jZVN0YXJ0O1xuXG4gICAgICAgIHRoaXMuZmlsZVR5cGUgPSBmaWxlVHlwZSB8fCAnLnBuZyc7XG5cbiAgICAgICAgdGhpcy5zY3JvbGxIZWlnaHQgPSBkb2N1bWVudC5ib2R5LnNjcm9sbEhlaWdodDtcbiAgICAgICAgdGhpcy5zY3JvbGxPZmZzZXQgPSBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcDtcbiAgICAgICAgdGhpcy5jbGllbnRIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7XG5cbiAgICAgICAgdGhpcy5sb2FkQ2FsbGJhY2sgPSBsb2FkQ2FsbGJhY2sgfHwgZnVuY3Rpb24oKSB7fTtcbiAgICAgICAgdGhpcy5vbkRyYXcgPSB0eXBlb2Ygb25EcmF3ID09PSAnZnVuY3Rpb24nID8gb25EcmF3IDogbnVsbDtcbiAgICAgICAgdGhpcy5hdXRvUGxheSA9IGF1dG9QbGF5O1xuICAgICAgICB0aGlzLmlzUGF1c2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZnBzID0gZnBzO1xuXG4gICAgICAgIHRoaXMubG9hZFNlcXVlbmNlKCk7XG4gICAgfVxuXG4gICAgcGF1c2UoKSB7XG4gICAgICAgIHRoaXMuaXNQYXVzZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIHBsYXkoKSB7XG4gICAgICAgIGlmICghdGhpcy5pc1BhdXNlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gcmVzZXQgc3RhcnRUaW1lIHNvIHRoYXQgaXQgaXMgcmVsYXRpdmUgdG8gdGhlIGN1cnJlbnQgcmVwbGF5IHRpbWVcbiAgICAgICAgY29uc3Qgbm93ID0gK25ldyBEYXRlKCk7XG4gICAgICAgIHRoaXMuc3RhcnRUaW1lID0gbm93IC0gKHRoaXMuY3VycmVudEZyYW1lIC8gdGhpcy5mcHMgKiAxMDAwKVxuICAgICAgICB0aGlzLmlzUGF1c2VkID0gZmFsc2U7XG4gICAgfVxuXG4gICAgYWRkTGVhZGluZ1plcm9zKG4pIHtcbiAgICAgICAgdmFyIGxlbmd0aCA9IHRoaXMuc2VxdWVuY2VFbmQudG9TdHJpbmcoKS5sZW5ndGg7XG4gICAgICAgIHZhciBzdHIgPSAobiA+IDAgPyBuIDogLW4pICsgXCJcIjtcbiAgICAgICAgdmFyIHplcm9zID0gXCJcIjtcbiAgICAgICAgZm9yICh2YXIgaSA9IGxlbmd0aCAtIHN0ci5sZW5ndGg7IGkgPiAwOyBpLS0pXG4gICAgICAgICAgICB6ZXJvcyArPSBcIjBcIjtcbiAgICAgICAgemVyb3MgKz0gc3RyO1xuICAgICAgICByZXR1cm4gbiA+PSAwID8gemVyb3MgOiBcIi1cIiArIHplcm9zO1xuICAgIH1cblxuICAgIGxvYWRTZXF1ZW5jZSgpIHtcblxuICAgICAgICB2YXIgcHJvbWlzZXMgPSBbXTtcblxuICAgICAgICBmb3IodmFyIGkgPSB0aGlzLnNlcXVlbmNlU3RhcnQ7IGkgPD0gdGhpcy5zZXF1ZW5jZUVuZDsgaSsrKSB7XG5cbiAgICAgICAgICAgIHZhciBmcmFtZU51bWJlciA9IHRoaXMuYWRkTGVhZGluZ1plcm9zKGkpO1xuICAgICAgICAgICAgdmFyIGZpbGVuYW1lID0gdGhpcy5zZXF1ZW5jZVBhdGggKyBmcmFtZU51bWJlciArIHRoaXMuZmlsZVR5cGU7XG4gICAgICAgICAgICB2YXIgaW1nID0gbmV3IEltYWdlO1xuICAgICAgICAgICAgaW1nLnNyYyA9IGZpbGVuYW1lO1xuXG4gICAgICAgICAgICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgIGltZy5vbmxvYWQgPSByZXNvbHZlO1xuICAgICAgICAgICAgICAgIGltZy5vbmVycm9yID0gcmVqZWN0O1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHByb21pc2VzLnB1c2gocHJvbWlzZSk7XG5cbiAgICAgICAgICAgIHRoaXMuc2VxdWVuY2UucHVzaChpbWcpO1xuICAgICAgICB9XG5cbiAgICAgICAgUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJGcmFtZSgpO1xuICAgICAgICAgICAgdGhpcy5sb2FkQ2FsbGJhY2soKTtcbiAgICAgICAgfSkuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBnZXRTY3JvbGxGcmFtZU51bWJlcigpIHtcbiAgICAgICAgdmFyIHNjcm9sbFBlcmNlbnRhZ2UgPSAodGhpcy5zY3JvbGxPZmZzZXQvKHRoaXMuc2Nyb2xsSGVpZ2h0LXRoaXMuY2xpZW50SGVpZ2h0KSkqMTAwO1xuICAgICAgICB2YXIgY3VycmVudEZyYW1lTnVtYmVyID0gTWF0aC5yb3VuZChzY3JvbGxQZXJjZW50YWdlKnRoaXMuc2VxdWVuY2VMZW5ndGgvMTAwKTtcbiAgICAgICAgcmV0dXJuIGN1cnJlbnRGcmFtZU51bWJlcjtcbiAgICB9XG5cbiAgICBnZXRBdXRvUGxheUZyYW1lTnVtYmVyKCkge1xuICAgICAgICByZXR1cm4gTWF0aC5yb3VuZCh0aGlzLmZwcyAqIHRoaXMucGxheU9mZnNldCk7XG4gICAgfVxuXG4gICAgZ2V0TmV4dEZyYW1lTnVtYmVyKCkge1xuICAgICAgICBpZiAodGhpcy5hdXRvUGxheSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QXV0b1BsYXlGcmFtZU51bWJlcigpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsRnJhbWVOdW1iZXIoKTtcbiAgICB9XG5cbiAgICBzeW5jU2Nyb2xsUG9zaXRpb24oKSB7XG4gICAgICAgIHRoaXMuc2Nyb2xsT2Zmc2V0ID0gZG9jdW1lbnQuYm9keS5zY3JvbGxUb3A7XG4gICAgfVxuXG4gICAgc3luY0F1dG9QbGF5UG9zaXRpb24oKSB7XG4gICAgICAgIGNvbnN0IG5vdyA9ICtuZXcgRGF0ZSgpO1xuICAgICAgICBpZiAoIXRoaXMuc3RhcnRUaW1lKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IG5vdztcbiAgICAgICAgICAgIHRoaXMuaXNQYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5pc1BhdXNlZCkge1xuICAgICAgICAgICAgdGhpcy5wbGF5T2Zmc2V0ID0gKChub3cgLSB0aGlzLnN0YXJ0VGltZSkgLyAxMDAwKSAlICh0aGlzLnNlcXVlbmNlTGVuZ3RoIC8gdGhpcy5mcHMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3luY1BsYXlQb3NpdGlvbigpIHtcbiAgICAgICAgLy8gbm8gc2Nyb2xsIHRyYWNraW5nIGZvciBhdXRvcGxheVxuICAgICAgICBpZiAodGhpcy5hdXRvUGxheSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3luY0F1dG9QbGF5UG9zaXRpb24oKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLnN5bmNTY3JvbGxQb3NpdGlvbigpO1xuICAgIH1cblxuICAgIGRyYXdJbWFnZShmcmFtZSkge1xuXG4gICAgICAgIGlmKGZyYW1lID49IDAgJiYgZnJhbWUgPCB0aGlzLnNlcXVlbmNlLmxlbmd0aCkge1xuICAgICAgICAgICAgLy8gdGhpcy5jb250ZXh0LmNsZWFyUmVjdCgwLCAwLCB0aGlzLmNhbnZhcy53aWR0aCwgdGhpcy5jYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgICAgIGlmKHRoaXMuc2VxdWVuY2VbZnJhbWVdLmNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmRyYXdJbWFnZSh0aGlzLnNlcXVlbmNlW2ZyYW1lXSwgMCwgMCwgdGhpcy5jYW52YXMud2lkdGgsIHRoaXMuY2FudmFzLmhlaWdodCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVGhlIGN1cnJlbnQgZnJhbWUgaGFzIG5vdCBiZWVuIGxvYWRlZC4gUGxlYXNlIGVuc3VyZSBhbGwgaW1hZ2VzIGFyZSBsb2FkZWQgYmVmb3JlIHVwZGF0aW5nIHRoZSBjYW52YXMuXCIpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHJlbmRlckZyYW1lKCkge1xuXG4gICAgICAgIHRoaXMuc3luY1BsYXlQb3NpdGlvbigpO1xuXG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlckZyYW1lKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMucHJldmlvdXNGcmFtZSA9IHRoaXMuY3VycmVudEZyYW1lO1xuICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuZ2V0TmV4dEZyYW1lTnVtYmVyKCk7XG5cbiAgICAgICAgaWYgKCh0aGlzLmN1cnJlbnRGcmFtZSAhPSB0aGlzLnByZXZpb3VzRnJhbWUpIHx8IHRoaXMuZmlyc3RMb2FkKSB7XG4gICAgICAgICAgICB0aGlzLmRyYXdJbWFnZSh0aGlzLmN1cnJlbnRGcmFtZSk7XG4gICAgICAgICAgICB0aGlzLm9uRHJhdyAmJiB0aGlzLm9uRHJhdy5jYWxsKG51bGwsIHRoaXMucHJldmlvdXNGcmFtZSwgdGhpcy5jdXJyZW50RnJhbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5maXJzdExvYWQgPSBmYWxzZTtcbiAgICB9XG5cbn1cblxuaWYgKCF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSB7XG4gICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IChmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHxcbiAgICAgICAgICAgIHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgLy8gY29tbWVudCBvdXQgaWYgRkY0IGlzIHNsb3cgKGl0IGNhcHMgZnJhbWVyYXRlIGF0IH4zMGZwczogaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjMwMTI3KVxuICAgICAgICAgICAgd2luZG93Lm9SZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHxcbiAgICAgICAgICAgIHdpbmRvdy5tc1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fFxuICAgICAgICAgICAgZnVuY3Rpb24oIC8qIGZ1bmN0aW9uIEZyYW1lUmVxdWVzdENhbGxiYWNrICovIGNhbGxiYWNrLCAvKiBET01FbGVtZW50IEVsZW1lbnQgKi8gZWxlbWVudCkge1xuICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGNhbGxiYWNrLCAxMDAwIC8gNjApO1xuICAgICAgICAgICAgfTtcbiAgICB9KSgpO1xufVxuXG5pZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7XG4gICAgZGVmaW5lKCdDYW52YXNTZXF1ZW5jZScsIENhbnZhc1NlcXVlbmNlKTtcbn0gZWxzZSBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpIHtcbiAgICBtb2R1bGUuZXhwb3J0cyA9IENhbnZhc1NlcXVlbmNlO1xufSBlbHNlIHtcbiAgICB3aW5kb3cuQ2FudmFzU2VxdWVuY2UgPSBDYW52YXNTZXF1ZW5jZTtcbn1cbiJdfQ==
